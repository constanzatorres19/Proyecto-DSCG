<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mockups SCT - McDonald's</title>
  <style>
    /* ==========================================
      Estilos globales - Paleta McDonald's
      ========================================== */
    :root{
      --mc-red: #D91D0E;
      --mc-yellow: #FFC300;
      --mc-dark: #222;
      --mc-light: #f7f7f7;
      --card-radius:16px;
      --gap:14px;
      font-family: Inter, system-ui, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg, var(--mc-yellow) 0%, var(--mc-yellow) 50%, #ffffff 100%);}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}

    /* Contenedor principal */
    .frame{width:100%;max-width:1300px;background:white;border-radius:18px;padding:18px;box-shadow:0 6px 28px rgba(0,0,0,0.12); border: 4px solid var(--mc-red);}

    /* --- Nuevo Diseño de Encabezado --- */
    /* El .app ya no centra verticalmente para las pantallas de rol */
    .app.logged-in {
      align-items: flex-start; /* Alinear arriba cuando está logueado */
      padding-top: 0;
      padding-bottom: 20px;
    }
    .app.logged-in .frame {
      padding-bottom: 30px; /* Espacio extra en el fondo */
      min-height: calc(100vh - 40px);
    }
    .app:not(.logged-in) .frame {
      min-width: 400px; /* Ancho mínimo para la vista de login */
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee; /* Separador */
    }
    .brand{display:flex;align-items:center;gap:12px}

    /* Logo Placeholder Style */
    .logo-container {
      width: 50px; height: 50px;
      background: transparent;
      border: 3px solid var(--mc-yellow);
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 30px; font-weight: 900; color: var(--mc-red);
      line-height: 0;
      box-shadow: 0 0 0 5px var(--mc-red);
    }
    /* Estilo para si el usuario usa una imagen */
    .logo-img { width: 50px; height: auto; }

    h1{font-size:24px;margin:0;color:var(--mc-dark)}
    h2{color: var(--mc-red);}
    .role-badge{background:var(--mc-red);color:white;padding:8px 12px;border-radius:999px;font-weight:600}

    /* Layout principal - columnas */
    .container{display:grid;grid-template-columns:250px 1fr;gap:18px}
    /* Para el login, centrar el main en el frame */
    .app:not(.logged-in) .container {
      display: flex;
      justify-content: center;
    }
    .app:not(.logged-in) .sidebar {
      display: none;
    }
    .app:not(.logged-in) .main {
      width: 100%;
      max-width: 400px;
      margin-top: 30px;
    }

    /* Sidebar / menú */
    .sidebar{background:var(--mc-light);border-radius:12px;padding:12px;border:2px solid rgba(0,0,0,0.08)}
    .side-block{display:flex;flex-direction:column;gap:15px} /* Aumentado a 15px para más separación entre bloques */
    
    /* Para separar los botones dentro de cada bloque de rol */
    #menuAdmin, #menuRRHH, #menuGerente, #menuEntrenador, #menuCrew {
      display: flex;
      flex-direction: column;
      gap: 30px; /* MODIFICADO: Aumentado el gap a 30px para asegurar la separación */
    }
    
    /* Eliminar/Ajustar espacio entre HOME y botones de rol (usar gap de side-block) */
    .side-block > .menu-btn { margin-bottom: 0; }
    
    button.menu-btn, .btn-primary{background:var(--mc-red);color:white;border:none;padding:10px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-sec{background:var(--mc-yellow);color:var(--mc-dark);border:none;}
    .small{font-size:13px;color:#333}

    /* Main content area */
    .main{background:#fff;border-radius:12px;padding:14px;min-height:460px;border:2px solid rgba(0,0,0,0.03)}
    .screen{display:none}
    .screen.active{display:block}
    
    /* Para formularios más anchos en las pantallas logueadas */
    .app.logged-in form {
      max-width: 600px;
      margin: 0 auto; /* Centrar formularios */
    }
    .app.logged-in .main h2 {
      text-align: center;
      margin-top: 0;
    }
    .app.logged-in .main .muted:first-of-type {
      text-align: center;
      margin-bottom: 20px;
    }


    /* Formularios y tablas */
    form{display:flex;flex-direction:column;gap:10px}
    label{font-weight:600;font-size:13px}
    input[type="text"], input[type="time"], input[type="date"], input[type="password"], select, textarea{padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px; background: #fff;}
    textarea{min-height:80px}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    /* Para botones auto en la fila */
    .row .col-auto {
      flex: 0 0 auto;
    }
    .muted{color:#666;font-size:13px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:var(--mc-light);font-weight: 700;}

    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-sec{background:var(--mc-yellow)}
    .btn-approve { background: #4CAF50; color: white; }
    .btn-reject { background: var(--mc-red); color: white; }

    /* Estados de Solicitud */
    .estado-aprobado { color: green; font-weight: bold; }
    .estado-rechazado { color: var(--mc-red); font-weight: bold; }
    .estado-pendiente { color: #8a6d3b; background: #fcf8e3; padding: 3px 6px; border-radius: 5px; font-size: 12px; border: 1px solid #faebcc;} /* Nuevo estilo de pendiente */

    /* Contenedores específicos */
    .grid-malla { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-top: 15px; }
    .day-header { background: var(--mc-red); color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px 5px 0 0; }
    .turno-box { background: var(--mc-yellow); padding: 5px; border-radius: 5px; font-size: 12px; text-align: center; margin-bottom: 5px; cursor: pointer; }
    .turno-box.pendiente { border: 2px dashed #f0ad4e; } /* Para turnos nuevos o editados */
    .turno-libre { background: #aaa; color: #fff; padding: 5px; border-radius: 5px; font-size: 12px; text-align: center; margin-bottom: 5px; }

    /* Estilos para KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    .kpi-card { padding: 15px; border-radius: 12px; background: var(--mc-light); border: 1px solid #ddd; }
    .kpi-value { font-size: 32px; font-weight: bold; margin: 5px 0; }
    .kpi-status { padding: 5px 10px; border-radius: 8px; font-weight: bold; display: inline-block; margin-top: 10px; font-size: 14px; }
    .kpi-status.expected { background: #f0ad4e; color: #333; }
    .kpi-status.better { background: #4CAF50; color: white; }
    .kpi-status.deficient { background: var(--mc-red); color: white; }

    /* Responsivo */
    @media(max-width:900px){
      .container{grid-template-columns:1fr}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">

      <header>
        <div class="brand">
          <img src="logo_mc.png" alt="McDonald's Logo" class="logo-img">
          <div>
            <h1>Sistema de Control de Turnos McDonald's</h1>
            <div class="muted">Diseño de Mockup Funcional - 5 Roles</div>
          </div>
        </div>
        <div id="headerRole" class="role-badge">Rol: Invitado</div>
      </header>

      <div class="container">

        <aside class="sidebar">
          <div class="side-block">
            <div id="userBox">
              <div class="muted">Usuario:</div>
              <div id="userName" style="font-weight:700">(no has iniciado sesión)</div>
            </div>
            
            <button id="homeButton" class="menu-btn" style="display:none" onclick="nav('home')">Home</button>

            <div id="menuAdmin" style="display:none">
              <button class="btn btn-sec" onclick="nav('gestionUsuarios')">Gestión de Usuarios</button>
            </div>
            
            <div id="menuRRHH" style="display:none">
              <button class="btn btn-sec" onclick="nav('visualizarMalla')">Malla Horaria Publicada</button>
              <button class="btn btn-sec" onclick="nav('kpisRRHH')">Panel de KPIs</button>
            </div>
            
            <div id="menuGerente" style="display:none">
              <button class="btn btn-sec" onclick="nav('planificarRRHH')">Crear/Editar Malla Horaria</button>
              <button class="btn btn-sec" onclick="nav('planificarPosiciones')">Asignar Posiciones Operativas</button>
              <button class="btn btn-sec" onclick="nav('revisarSolicitudesTurno')">Solicitudes de Cambio de Turno</button>
              <button class="btn btn-sec" onclick="nav('revisarSolicitudesPosicion')">Solicitudes de Posición (Entr.)</button>
            </div>
            
            <div id="menuEntrenador" style="display:none">
              <button class="btn btn-sec" onclick="nav('visualizarMalla')">Malla con Posiciones</button>
              <button class="btn btn-sec" onclick="nav('misTurnosYCambioEntrenador')">Mis Turnos y Solicitud de Cambio</button>
              <button class="btn btn-sec" onclick="nav('solicitarCambioPosicionAll')">Solicitar Cambio de Posición (Todos)</button>
              <button class="btn btn-sec" onclick="nav('historialPosicion')">Estado de Solicitudes (Mías)</button>
            </div>
            
            <div id="menuCrew" style="display:none">
              <button class="btn btn-sec" onclick="nav('miPlanilla')">Mi Horario y Posición</button>
              <button class="btn btn-sec" onclick="nav('solicitarCambioTurno')">Solicitar Cambio de Turno</button>
              <button class="btn btn-sec" onclick="nav('estadoSolicitudes')">Estado de Solicitudes</button>
              <button class="btn btn-sec" onclick="nav('historial')">Historial de Turnos</button>
            </div>

            <div style="margin-top:10px">
              <button class="btn" id="btnLogout" style="display:none" onclick="logout()">Cerrar sesión</button>
              <button class="btn btn-primary" id="btnLogin" onclick="nav('login')">Iniciar sesión</button>
            </div>
            
            <div style="margin-top:18px" class="muted">Tips de Prueba:</div>
            <div class="muted" style="font-size:12px">
              Usuario/Contraseña: `demo`/`1234`<br>
              Roles a probar: `admin`, `rrhh`, `gerente`, `entrenador`, `crew`.
            </div>
          </div>
        </aside>

        <main class="main">

          <section id="login" class="screen active">
            <h2>Login de Acceso</h2>
            <p class="muted">Ingresa tu usuario, contraseña y rol para acceder al sistema.</p>
            <form onsubmit="event.preventDefault(); doLogin()">
              <label>Usuario</label>
              <input id="loginUsuario" type="text" placeholder="Ej: demo" required>
              
              <label>Contraseña</label>
              <input id="loginPass" type="password" placeholder="Ej: 1234" required>

              <label>Rol</label>
              <select id="loginRol">
                <option value="admin">Admin</option>
                <option value="rrhh">RR.HH.</option>
                <option value="gerente">Gerente</option>
                <option value="entrenador">Entrenador</option>
                <option value="crew">Crew</option>
              </select>

              <div class="row">
                <div class="col">
                  <button class="btn btn-primary" type="submit">Ingresar</button>
                </div>
                <div class="col">
                  <button class="btn btn-sec" type="button" onclick="seedDemo()">Cargar Demo</button>
                </div>
              </div>
            </form>
          </section>

          <section id="home" class="screen">
            <h2>Home (Gerente)</h2>
            <div class="muted">Bienvenido a tu panel de control. Usa el menú lateral para gestionar tus tareas.</div>
            <div style="margin-top:12px">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1;min-width:220px;background:var(--mc-light);padding:12px;border-radius:10px">
                  <strong>Planilla publicada:</strong>
                  <div id="homePlanillaInfo" class="muted">Sin datos cargados</div>
                </div>
                <div style="flex:1;min-width:220px;background:var(--mc-light);padding:12px;border-radius:10px">
                  <strong>Solicitudes pendientes:</strong>
                  <div id="homeSolicitudesInfo" class="muted">0</div>
                </div>
              </div>
            </div>
          </section>

          <section id="gestionUsuarios" class="screen">
            <h2>Gestión de Usuarios (Admin)</h2>
            <button class="btn btn-primary" onclick="toggleForm('formCrearUsuario')">Crear Nuevo Usuario</button>
            <p class="muted">El Admin puede crear, editar y eliminar cualquier usuario del sistema.</p>

            <div id="formCrearUsuario" style="display:none; border:1px solid #ddd; padding:15px; border-radius:10px; margin-top:10px;">
                <h3>Crear/Editar Usuario</h3>
                <form id="adminUserForm" onsubmit="event.preventDefault(); guardarUsuarioAdmin()">
                    <label>Nombre Completo</label><input type="text" id="adminNewName" placeholder="Nombre Apellido">
                    <label>Usuario (Login)</label><input type="text" id="adminNewUser" placeholder="user.login">
                    <label>Contraseña</label><input type="password" id="adminNewPass" placeholder="********">
                    <label>Rol</label>
                    <select id="adminNewRole">
                        <option value="crew">Crew</option><option value="gerente">Gerente</option><option value="admin">Admin</option><option value="rrhh">RR.HH.</option><option value="entrenador">Entrenador</option>
                    </select>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" type="submit">Guardar Usuario</button>
                        <button class="btn" type="button" onclick="toggleForm('formCrearUsuario')">Cancelar</button>
                    </div>
                </form>
            </div>

            <h3 style="margin-top: 20px;">Listado de Usuarios</h3>
            <input type="text" id="filtroUsuarios" placeholder="Buscar por Nombre o Rol..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderTablaUsuarios()">
            <table id="tableUsuarios">
                <thead><tr><th>Nombre</th><th>Rol</th><th>Usuario</th><th>Última Modif.</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
          </section>
          
          <section id="kpisRRHH" class="screen">
            <h2>Panel de Indicadores Clave (RR.HH.)</h2>
            <p class="muted">Indicadores basados en la planificación de la semana: ${mallaMetadata.startDate} - ${mallaMetadata.endDate} (Publicada: ${mallaMetadata.publicationDate}).</p>
            
            <div id="kpisContainer" class="kpi-grid">
                </div>

          </section>
          <section id="planificarRRHH" class="screen">
            <h2>Creación de Malla Horaria Semanal (Gerente)</h2>
            <p class="muted">Planifique los turnos por empleado. Usted (Gerente) puede añadir las posiciones después.</p>

            <form onsubmit="event.preventDefault(); toggleForm('formAgregarTurnoRRHH')">
                <div class="row">
                    <div class="col">
                        <label>Inicio de Semana</label><input type="date" id="rrhhSemanaInicio" value="2025-10-28">
                    </div>
                    <div class="col">
                        <label>Fin de Semana</label><input type="date" id="rrhhSemanaFin" value="2025-11-03">
                    </div>
                </div>
                <div class="row" style="margin-bottom: 10px; margin-top: 10px;">
                    <div class="col-auto"><button class="btn btn-primary" type="button" onclick="alert('Malla publicada. Gerente puede añadir posiciones.')">Publicar Malla</button></div>
                    <div class="col-auto"><button class="btn" type="submit">Agregar Turno Manual</button></div>
                </div>
            </form>
            
            <div id="formAgregarTurnoRRHH" style="display:none; border:1px solid #ddd; padding:15px; border-radius:10px; margin-top:10px;">
                <h3>Agregar/Editar Turno</h3>
                <form onsubmit="event.preventDefault(); guardarTurnoRRHH();">
                    <label>Empleado</label>
                    <select id="rrhhEmpleadoTurno">
                        </select>
                    <label>Día del Turno</label>
                    <select id="rrhhDiaTurno">
                        </select>
                    
                    <label>Clasificación de Turno</label>
                    <select id="rrhhClasificacionTurno">
                        <option value="am">AM (Mañana)</option>
                        <option value="pm">PM (Tarde)</option>
                        <option value="nocturno">Nocturno</option>
                    </select>

                    <label>Tipo de Turno</label>
                    <select id="rrhhTipoTurno" onchange="document.getElementById('turnos-row').style.display = (this.value === 'Libre') ? 'none' : 'flex'">
                        <option value="Normal">Turno Normal (Horas)</option>
                        <option value="Libre">Día Libre (No Asignar Turno)</option>
                    </select>

                    <div class="row" id="turnos-row">
                        <div class="col">
                            <label>Hora Inicio</label><input type="time" id="rrhhHoraInicio">
                        </div>
                        <div class="col">
                            <label>Hora Fin</label><input type="time" id="rrhhHoraFin">
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" type="submit">Guardar Turno</button>
                        <button class="btn" type="button" onclick="toggleForm('formAgregarTurnoRRHH')">Cancelar</button>
                    </div>
                    <input type="hidden" id="rrhhTurnoId" value="">
                </form>
            </div>

            <h3 style="margin-top: 20px;">Vista Semanal (Simulación)</h3>
            <div id="rrhhMallaContainer">
                <p class="muted">Cargando malla...</p>
            </div>
          </section>

          <section id="revisarSolicitudesTurno" class="screen">
            <h2>Solicitudes de Cambio de Turno Pendientes (Gerente)</h2>
            <p class="muted">Revisa y aprueba/rechaza los cambios solicitados por el Crew.</p>
            <table id="tableSolicitudesTurno">
              <thead><tr><th>Empleado</th><th>Fecha Solicitud</th><th>Turno original</th><th>Turno pedido</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody>
                </tbody>
            </table>
          </section>

          <section id="visualizarMalla" class="screen">
            <h2>Visualizar Malla Horaria (Turnos + Posiciones) (RR.HH. y Entrenador)</h2>
            <div id="mallaVisualizacionHeader"></div> <p class="muted">Vista de la malla completa (turnos creados por Gerente y posiciones añadidas por el Gerente).</p>
            <input type="text" id="filtroMallaVisualizacion" placeholder="Buscar por Empleado, Posición o Fecha..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMallaPublicada()">
            <table id="tableMallaVisualizacion">
                <thead><tr><th>Empleado</th><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Cargo</th><th>Posición</th></tr></thead>
                <tbody>
                    </tbody>
            </table>
          </section>
          
          <section id="planificarPosiciones" class="screen">
            <h2>Planificar Posiciones del Personal Operativo (Gerente)</h2>
            <p class="muted">Asigna la posición operativa (Caja, Cocina, Automac) a cada turno en la malla publicada.</p>
            
            <div class="row" style="margin-bottom: 15px;">
                <div class="col-auto"><button class="btn btn-primary" onclick="alert('Posiciones publicadas. Entrenador puede visualizar.')">Publicar Posiciones</button></div>
            </div>

            <h3 style="margin-top: 15px;">Malla para Asignación de Posición</h3>
            <input type="text" id="filtroPlanifPosiciones" placeholder="Buscar por Empleado, Posición o Fecha..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderPlanifPosiciones()">
            <table id="tablePlanifPosiciones">
                <thead><tr><th>Empleado</th><th>Fecha</th><th>Turno</th><th>Clasificación</th><th>Posición Actual</th><th>Acciones</th></tr></thead>
                <tbody>
                    </tbody>
            </table>
          </section>

          <section id="revisarSolicitudesPosicion" class="screen">
            <h2>Solicitudes de Cambio de Posición Pendientes (Gerente)</h2>
            <p class="muted">Revisa y aprueba/rechaza los cambios de posición solicitados por los Entrenadores.</p>
            <table id="tableSolicitudesPosicion">
              <thead><tr><th>Entrenador</th><th>Fecha Solicitud</th><th>Turno</th><th>Posición Original</th><th>Posición Pedida</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody>
                </tbody>
            </table>
          </section>
          
          
          <section id="solicitarCambioPosicionAll" class="screen">
            <h2>Solicitar Cambio de Posición (Cualquier Turno) (Entrenador)</h2>
            <p class="muted">El Entrenador puede solicitar al Gerente cambiar la posición asignada en **cualquier turno** de la malla.</p>
            <form onsubmit="event.preventDefault(); enviarSolicitudEntrenadorPosicionAll()">
                <label>Turno a Modificar</label>
                <select id="selectTodosLosTurnos" style="width: 100%;"></select>

                <label>Posición Solicitada</label>
                <input id="posicionPedidaAll" type="text" placeholder="Ej: Cocina" required>

                <label>Motivo del cambio</label>
                <textarea id="motivoCambioPosAll" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                </div>
            </form>
          </section>
          
          <section id="solicitarCambioTurno" class="screen">
            <h2>Solicitar Cambio de Turno (a Gerente)</h2>
            <p class="muted">Selecciona el turno que quieres cambiar y sugiere una alternativa para enviarla al Gerente.</p>
            
            <div id="solicitarCambioTurnoWrapper">
                <form onsubmit="event.preventDefault(); enviarSolicitud('Turno')">
                    <label>Turno Asignado a Modificar</label>
                    <select id="selectMisTurnosTurno" style="width: 100%;" onchange="prepararSolicitudCambioTurno(this.value)">
                      </select>
                    
                    <input type="hidden" id="turnoIdACambiar"> 
                    <p class="muted" style="margin-top: -10px;">Turno Original: <strong id="turnoOriginalInfo">N/A</strong></p>

                    <label>Turno Sugerido (fecha/hora)</label>
                    <input id="sugFecha" type="date" required>
                    <div class="row">
                        <div class="col"><input id="sugInicio" type="time" required></div>
                        <div class="col"><input id="sugFin" type="time" required></div>
                    </div>

                    <label>Motivo del cambio</label>
                    <textarea id="motivoCambio" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                    </div>
                </form>
            </div>
          </section>
          <section id="misTurnosYCambioEntrenador" class="screen">
              <h2>Mi Horario y Solicitud de Cambio (Entrenador)</h2>
              <div id="miPlanillaEntrenadorHeader"></div> <p class="muted">Tu horario personal asignado. Usa el formulario de abajo para solicitar un cambio de turno al Gerente.</p>
              
              <input type="text" id="filtroMiPlanillaEntrenador" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMiPlanillaEntrenador()">
              <table id="tableMiPlanillaEntrenador"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
              </tbody></table>

              <h3 style="margin-top: 30px;">Solicitar Cambio de Turno</h3>
              <div id="solicitarCambioTurnoEntrenadorWrapper">
                  <form onsubmit="event.preventDefault(); enviarSolicitudTurnoEntrenador()">
                      <label>Turno Asignado a Modificar</label>
                      <select id="selectMisTurnosTurnoEntrenador" style="width: 100%;" onchange="prepararSolicitudCambioTurnoEntrenador(this.value)">
                          </select>
                      
                      <input type="hidden" id="turnoIdACambiarEntrenador"> 
                      <p class="muted" style="margin-top: -10px;">Turno Original: <strong id="turnoOriginalInfoEntrenador">N/A</strong></p>

                      <label>Turno Sugerido (fecha/hora)</label>
                      <input id="sugFechaEntrenador" type="date" required>
                      <div class="row">
                          <div class="col"><input id="sugInicioEntrenador" type="time" required></div>
                          <div class="col"><input id="sugFinEntrenador" type="time" required></div>
                      </div>

                      <label>Motivo del cambio</label>
                      <textarea id="motivoCambioEntrenador" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                      <div style="display:flex;gap:8px;margin-top:8px;">
                          <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                      </div>
                  </form>
              </div>
          </section>
          
          <section id="historialPosicion" class="screen">
            <h2>Estado de Solicitudes de Posición (Entrenador)</h2>
            <p class="muted">Revisa el estado de las solicitudes de cambio de posición que has enviado al Gerente.</p>
            <table id="tableHistorialPosicion"><thead><tr><th>Fecha solicitud</th><th>Turno</th><th>Posición Pedida</th><th>Estado</th></tr></thead><tbody>
                  </tbody></table>
          </section>

          <section id="miPlanilla" class="screen">
            <h2>Mi Horario y Posición Asignada (Crew)</h2>
            <div id="miPlanillaHeader"></div> <p class="muted">Tu horario personal (turnos y posición asignada por el Gerente).</p>
            <input type="text" id="filtroMiPlanilla" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMiPlanilla()">
            <table id="tableMiPlanilla"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
                </tbody></table>
            </section>

          <section id="estadoSolicitudes" class="screen">
            <h2>Estado de Mis Solicitudes de Cambio (Crew)</h2>
            <p class="muted">Aquí puedes ver el estado de tus solicitudes de cambio de turno (Gerente).</p>
            <table id="tableEstadoSolicitudes"><thead><tr><th>Tipo</th><th>Turno Original</th><th>Turno Pedido</th><th>Estado</th></tr></thead><tbody>
                </tbody></table>
          </section>


          <section id="historial" class="screen">
            <h2>Historial de Turnos (Personales) (Crew)</h2>
            <p class="muted">Turnos completados y registros pasados.</p>
            <input type="text" id="filtroHistorial" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderHistorial()">
            <table id="tableHistorial"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
                </tbody></table>
          </section>
          
        </main>
      </div>
    </div>
  </div>

  <script>
    /* ======================================
      Variables en memoria (simulan DB temporal)
      ====================================== */

    let currentUser = null; // {name, role}
    let allUsers = [
        { name: 'Admin User', role: 'admin', user: 'admin', pass: '1234' },
        { name: 'Ricardo RRHH', role: 'rrhh', user: 'rrhh', pass: '1234' },
        { name: 'Gerente Jefe', role: 'gerente', user: 'gerente', pass: '1234' },
        { name: 'Entrenador Juan', role: 'entrenador', user: 'entrenador', pass: '1234' },
        { name: 'Crew Constanza', role: 'crew', user: 'crew', pass: '1234' },
        { name: 'Crew Felipe', role: 'crew', user: 'felipe', pass: '1234' }, // Para demo de Entrenador
    ];

    let planillaPublicada = []; // Malla con Turnos + Posiciones

    // NEW: Malla Metadata for visualization
    let mallaMetadata = {
        startDate: '2025-10-28',
        endDate: '2025-11-03',
        publicationDate: new Date('2025-10-26T10:00:00').toLocaleString() // Simulating publication 2 days before
    };
    
    let solicitudes = []; // Todas las solicitudes (Turno, PosicionEntrenador, PosicionCrew)


    const ROLES = {
        admin: 'Admin',
        rrhh: 'RR.HH.',
        gerente: 'Gerente',
        entrenador: 'Entrenador',
        crew: 'Crew'
    };

    const POSICIONES_BASE = ['Caja', 'Cocina', 'Automac', 'Sala', 'Lobby'];
    
    // Función de utilidad para alternar formularios
    function toggleForm(id){
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    /* ---------- FUNCIONES HOME/DASHBOARD ---------- */
    function updateHomeDashboard() {
        if (!currentUser) return;
        
        // Solo Gerente usa el home
        if (currentUser.role !== 'gerente') return;

        // FIX 1: Contar solo turnos de personal operativo (Crew o Entrenador) para la congruencia.
        const operationalShifts = planillaPublicada.filter(t => t.cargo !== 'Gerente' && t.cargo !== 'Admin' && t.cargo !== 'RR.HH.' && t.inicio !== 'Libre');
        
        // 1. Planilla Info 
        document.getElementById('homePlanillaInfo').innerText = operationalShifts.length + ' turnos operativos publicados'; 
        
        // 2. Solicitudes Pendientes
        // Gerente revisa Solicitudes de Turno ('Turno') y Solicitudes de Posición (Entr.) ('PosicionEntrenador')
        let pendingCount = solicitudes.filter(s => s.estado === 'Pendiente' && (s.tipo === 'Turno' || s.tipo === 'PosicionEntrenador')).length;
        
        document.getElementById('homeSolicitudesInfo').innerText = pendingCount;
    }


    // Navegación simple entre "pantallas" (secciones) del mockup
    function nav(screenId){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      const screen = document.getElementById(screenId);
      if(screen) screen.classList.add('active');

      // Mostrar/ocultar menús según rol
      document.getElementById('menuAdmin').style.display = (currentUser && currentUser.role==='admin') ? 'block' : 'none';
      document.getElementById('menuRRHH').style.display = (currentUser && currentUser.role==='rrhh') ? 'block' : 'none';
      document.getElementById('menuGerente').style.display = (currentUser && currentUser.role==='gerente') ? 'block' : 'none';
      document.getElementById('menuEntrenador').style.display = (currentUser && currentUser.role==='entrenador') ? 'block' : 'none';
      document.getElementById('menuCrew').style.display = (currentUser && currentUser.role==='crew') ? 'block' : 'none';

      document.getElementById('btnLogin').style.display = currentUser ? 'none' : 'inline-block';
      document.getElementById('btnLogout').style.display = currentUser ? 'inline-block' : 'none';

      document.getElementById('headerRole').innerText = currentUser ? `Rol: ${ROLES[currentUser.role]}` : 'Rol: Invitado';

      // Ajuste de diseño: Si está logueado, ajusta el app para que no centre verticalmente
      document.querySelector('.app').classList.toggle('logged-in', !!currentUser);
      
      // Mostrar Home button solo para Gerente (Roles que lo utilizan)
      const showHome = currentUser && (currentUser.role === 'gerente'); 
      document.getElementById('homeButton').style.display = showHome ? 'block' : 'none';

      // Acciones por pantalla que requieren renderizado
      if(screenId==='home') updateHomeDashboard();
      if(screenId==='gestionUsuarios') renderTablaUsuarios();
      if(screenId==='planificarRRHH') renderMallaRRHH(); // Función modificada
      if(screenId==='miPlanilla') {
        renderMiPlanilla();
      }
      // NEW KPI RENDER
      if(screenId==='kpisRRHH') renderKpisRRHH();
      
      if(screenId==='visualizarMalla') renderMallaPublicada();
      if(screenId==='planificarPosiciones') renderPlanifPosiciones();
      if(screenId==='revisarSolicitudesTurno') renderSolicitudes('Turno');
      if(screenId==='revisarSolicitudesPosicion') renderSolicitudes('PosicionEntrenador'); // Gerente revisa Entrenador
      if(screenId==='historial') renderHistorial();
      if(screenId==='estadoSolicitudes') renderEstadoSolicitudes();
      if(screenId==='solicitarCambioPosicionAll') populateTurnosAllSelect(); // Entrenador
      if(screenId==='solicitarCambioTurno') populateMisTurnosTurnoSelect(); // Crew: new screen
      
      // NEW SECTION FOR TRAINER
      if(screenId==='misTurnosYCambioEntrenador') {
        renderMiPlanillaEntrenador();
        populateMisTurnosTurnoSelectEntrenador(); 
      }
      
      if(screenId==='historialPosicion') renderHistorialPosicion(); // Entrenador
    }

    // Simula login (sin seguridad) - actualiza UI y menus
    function doLogin(){
      const user = document.getElementById('loginUsuario').value.trim().toLowerCase();
      const pass = document.getElementById('loginPass').value.trim();
      const rol = document.getElementById('loginRol').value;
      
      const foundUser = allUsers.find(u => u.user === user && u.pass === pass && u.role === rol);

      if(!foundUser) {
          alert('Credenciales incorrectas o Rol no coincide. Pruebe "admin", "rrhh", "gerente", "entrenador", "crew" con contraseña "1234".');
          return;
      }
      
      currentUser = foundUser;
      document.getElementById('userName').innerText = foundUser.name + ' (' + ROLES[foundUser.role] + ')';
      
      // Redirección inicial según el rol (Requisito del usuario)
      let initialScreen = 'home';
      if (foundUser.role === 'admin') initialScreen = 'gestionUsuarios';
      else if (foundUser.role === 'rrhh') initialScreen = 'visualizarMalla'; // RRHH directo a Malla (Home eliminado)
      else if (foundUser.role === 'entrenador') initialScreen = 'visualizarMalla'; // Entrenador directo a Malla (Home eliminado)
      else if (foundUser.role === 'crew') initialScreen = 'miPlanilla'; // Crew directo a Planilla (Home eliminado)

      nav(initialScreen);
    }

    function logout(){
      if(!confirm('Cerrar sesión?')) return;
      currentUser = null;
      document.getElementById('userName').innerText = '(no has iniciado sesión)';
      document.getElementById('headerRole').innerText = 'Rol: Invitado';
      nav('login');
    }

    /* ---------- FUNCIONES ADMIN (Gestion de Usuarios) ---------- */
    function renderTablaUsuarios() {
        const tbody = document.querySelector('#tableUsuarios tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroUsuarios').value.toLowerCase();
        
        allUsers.filter(u => 
            u.name.toLowerCase().includes(filtro) || 
            ROLES[u.role].toLowerCase().includes(filtro)
        ).forEach((u) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.name}</td><td>${ROLES[u.role]}</td><td>${u.user}</td><td>-</td><td class="actions">
                <button class='btn btn-sec' onclick='toggleForm("formCrearUsuario")'>Editar</button>
                <button class='btn btn-primary' onclick='eliminarUsuario("${u.user}")'>Eliminar</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }

    // NEW FUNCTION: Guarda un nuevo usuario en la lista
    function guardarUsuarioAdmin() {
        const name = document.getElementById('adminNewName').value.trim();
        const user = document.getElementById('adminNewUser').value.trim();
        const pass = document.getElementById('adminNewPass').value.trim();
        const role = document.getElementById('adminNewRole').value;

        if (!name || !user || !pass || !role) {
            return alert('Todos los campos son obligatorios para crear un usuario.');
        }

        if (allUsers.some(u => u.user === user)) {
            return alert('El usuario (login) ya existe. Intente con otro.');
        }

        const newUser = {
            name: name,
            role: role,
            user: user,
            pass: pass
        };

        allUsers.push(newUser);
        alert(`Usuario "${name}" (${ROLES[role]}) creado con éxito.`);
        
        // Reset form and re-render table
        document.getElementById('adminUserForm').reset();
        toggleForm('formCrearUsuario');
        renderTablaUsuarios();
    }

    function eliminarUsuario(user) {
        if (confirm(`¿Eliminar usuario ${user}? (Simulado)`)) {
            allUsers = allUsers.filter(u => u.user !== user);
            renderTablaUsuarios();
        }
    }
    
    /* ---------- FUNCIONES RRHH (KPIs) ---------- */

    function getKpiStatus(result, expected, isBetterHigher) {
        if (result === null) return { status: 'Deficiente', className: 'deficient' };
        
        if (isBetterHigher) {
            if (result > expected) return { status: 'Mejor de lo esperado', className: 'better' };
            if (result === expected) return { status: 'Esperado', className: 'expected' };
            return { status: 'Deficiente', className: 'deficient' };
        } else { // Better is lower (or equal for threshold)
            if (result < expected) return { status: 'Mejor de lo esperado', className: 'better' };
            if (result === expected) return { status: 'Esperado', className: 'expected' };
            return { status: 'Deficiente', className: 'deficient' };
        }
    }
    
    function renderKpisRRHH() {
        const container = document.getElementById('kpisContainer');
        if (!container) return;
        container.innerHTML = '<h3>Cálculo de Indicadores...</h3>';

        const operativos = allUsers.filter(u => u.role === 'crew' || u.role === 'entrenador');
        const totalOperativos = operativos.length;
        
        // Filtrar solo turnos operativos y reales (no días libres)
        const turnosOperativosReales = planillaPublicada.filter(t => 
            (t.cargo === 'Crew' || t.cargo === 'Entrenador') && t.inicio !== 'Libre'
        );
        const totalTurnosPlanificados = turnosOperativosReales.length;
        
        // ------------------------- KPI 1: Tasa de carga personal -------------------------
        const turnosPorClasificacion = turnosOperativosReales.reduce((acc, t) => {
            acc[t.clasificacion] = (acc[t.clasificacion] || 0) + 1;
            return acc;
        }, {});

        const kpi1 = [];
        const clasificaciones = ['am', 'pm', 'nocturno'];
        clasificaciones.forEach(c => {
            const count = turnosPorClasificacion[c] || 0;
            const tasa = totalOperativos > 0 ? (count / totalOperativos) * 100 : 0;
            const expected = 8;
            const status = getKpiStatus(tasa, expected, true); // Better is Higher ( > 8%)

            kpi1.push(`
                <div class="kpi-card">
                    <h4>Tasa de Carga: ${c.toUpperCase()}</h4>
                    <p class="muted">(${count} turnos diarios / ${totalOperativos} empleados operativos) * 100</p>
                    <div class="kpi-value">${tasa.toFixed(2)}%</div>
                    <div class="kpi-status ${status.className}">
                        ${status.status} (Esperado: ${expected}%)
                    </div>
                </div>
            `);
        });

        // ------------------------- KPI 2: Porcentaje modificaciones a turnos despues del plan semanal -------------------------
        const pubDate = new Date(mallaMetadata.publicationDate);
        
        // Contar modificaciones aprobadas/rechazadas que son de turno
        const solicitudesTurnoResueltas = solicitudes.filter(s => 
            s.tipo === 'Turno' && s.estado !== 'Pendiente'
        );
        
        // Filtramos por las que se respondieron *después* de la publicación de la malla (simula la fecha del "plan semanal")
        const modificacionesDespuesPlan = solicitudesTurnoResueltas.filter(s => {
            const fechaRespuesta = new Date(s.fechaRespuesta);
            return fechaRespuesta > pubDate;
        }).length;
        
        const porcentajeModificaciones = totalTurnosPlanificados > 0 ? 
                                         (modificacionesDespuesPlan / totalTurnosPlanificados) * 100 : 0;
        const expectedKpi2 = 10;
        // La lógica del usuario es confusa: "el resultado esperado es igual a 10%, mejor de lo esperado mayor a 10 % y deficiente menos a 10%."
        // Esto implicaría que más modificaciones es *mejor*. Mantendremos la lógica literal, pero se podría cuestionar si el KPI debería ser inverso.
        const statusKpi2 = getKpiStatus(porcentajeModificaciones, expectedKpi2, true);

        const kpi2 = `
            <div class="kpi-card">
                <h4>% Modificaciones Post-Plan</h4>
                <p class="muted">(${modificacionesDespuesPlan} turnos modificados / ${totalTurnosPlanificados} turnos planificados) * 100</p>
                <div class="kpi-value">${porcentajeModificaciones.toFixed(2)}%</div>
                <div class="kpi-status ${statusKpi2.className}">
                    ${statusKpi2.status} (Esperado: ${expectedKpi2}%)
                </div>
            </div>
        `;
        
        // ------------------------- KPI 3: Tasa de revisión oportuna de solicitudes -------------------------
        const totalSolicitudesRecibidas = solicitudes.filter(s => s.tipo === 'Turno' || s.tipo === 'PosicionEntrenador').length;
        
        const revisadasDentroPlazo = solicitudes.filter(s => 
            (s.tipo === 'Turno' || s.tipo === 'PosicionEntrenador') && 
            s.estado !== 'Pendiente' && 
            checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta) === 'dentro del plazo'
        ).length;
        
        const tasaRevision = totalSolicitudesRecibidas > 0 ? 
                             (revisadasDentroPlazo / totalSolicitudesRecibidas) * 100 : 0;
        const expectedKpi3 = 95;
        const statusKpi3 = getKpiStatus(tasaRevision, expectedKpi3, true); // Better is Higher ( > 95%)

        const kpi3 = `
            <div class="kpi-card">
                <h4>Tasa de Revisión Oportuna (Solicitudes)</h4>
                <p class="muted">(${revisadasDentroPlazo} solicitudes revisadas a tiempo / ${totalSolicitudesRecibidas} solicitudes recibidas) * 100</p>
                <div class="kpi-value">${tasaRevision.toFixed(2)}%</div>
                <div class="kpi-status ${statusKpi3.className}">
                    ${statusKpi3.status} (Esperado: ${expectedKpi3}%)
                </div>
            </div>
        `;

        container.innerHTML = kpi1.join('') + kpi2 + kpi3;
    }


    /* ---------- FUNCIONES GERENTE (Creación de Malla) ---------- */
    
    // Función para obtener las fechas de la semana seleccionada
    function getDatesOfWeek(startDateString) {
      const dates = [];
      const currentDate = new Date(startDateString);
      // Asegurar que la fecha sea la correcta ajustando la zona horaria
      currentDate.setHours(currentDate.getHours() + currentDate.getTimezoneOffset() / 60);

      for (let i = 0; i < 7; i++) {
          const date = new Date(currentDate);
          date.setDate(currentDate.getDate() + i);
          
          const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
          const day = date.getDay(); // 0 (Domingo) a 6 (Sábado)

          // Formato YYYY-MM-DD
          const yyyy = date.getFullYear();
          const mm = String(date.getMonth() + 1).padStart(2, '0');
          const dd = String(date.getDate()).padStart(2, '0');
          const dateString = `${yyyy}-${mm}-${dd}`;
          
          dates.push({
              date: dateString,
              dayName: dayNames[day],
              display: `${dayNames[day]} ${dd}/${mm}`
          });
      }
      return dates;
    }

    // Inicializa los selects del formulario de Gerente (Turnos)
    function setupRRHHForm(weekDates) {
        const selectEmpleado = document.getElementById('rrhhEmpleadoTurno');
        const selectDia = document.getElementById('rrhhDiaTurno');
        
        // Empleados (solo Crew y Entrenador pueden tener turnos operativos)
        selectEmpleado.innerHTML = allUsers
            .filter(u => u.role === 'crew' || u.role === 'entrenador')
            .map(u => `<option value="${u.name}|${u.role}">${u.name} (${ROLES[u.role]})</option>`)
            .join('');

        // Días de la semana
        selectDia.innerHTML = weekDates
            .map(d => `<option value="${d.date}">${d.display}</option>`)
            .join('');
    }
    
    // Renderiza la tabla de malla para Gerente (Turnos)
    function renderMallaRRHH() {
        const inicioSemana = document.getElementById('rrhhSemanaInicio').value;
        const weekDates = getDatesOfWeek(inicioSemana);
        document.getElementById('rrhhSemanaFin').value = weekDates[6].date; // Actualiza Fin de Semana
        
        setupRRHHForm(weekDates);

        const container = document.getElementById('rrhhMallaContainer');
        
        // 1. Crear el encabezado de la tabla
        let tableHTML = `<table style="font-size: 13px;"><thead><tr><th>Empleado</th>`;
        weekDates.forEach(d => {
            tableHTML += `<th>${d.display}</th>`;
        });
        tableHTML += `</tr></thead><tbody>`;

        // 2. Agrupar turnos por empleado
        const turnosPorEmpleado = planillaPublicada.reduce((acc, t) => {
            if (!acc[t.empleado]) acc[t.empleado] = {};
            acc[t.empleado][t.fecha] = t;
            return acc;
        }, {});
        
        // 3. Obtener solo empleados con turnos operativos (Crew y Entrenador)
        const empleadosOperativos = allUsers.filter(u => u.role === 'crew' || u.role === 'entrenador');

        // 4. Llenar la tabla
        empleadosOperativos.forEach(u => {
            tableHTML += `<tr><td>${u.name} (${ROLES[u.role]})</td>`;
            weekDates.forEach(d => {
                const turno = turnosPorEmpleado[u.name] ? turnosPorEmpleado[u.name][d.date] : null;
                if (turno) {
                    const turnoId = `${turno.id}`;
                    const isLibre = turno.inicio === 'Libre';
                    const clasificacion = turno.clasificacion ? ` (${turno.clasificacion.toUpperCase()})` : '';
                    tableHTML += `<td><div class="turno-box ${isLibre ? 'turno-libre' : ''}" onclick="abrirFormEditarTurno('${turnoId}')">
                                      ${isLibre ? 'DÍA LIBRE' : `${turno.inicio} - ${turno.fin}${clasificacion}`}
                                  </div></td>`;
                } else {
                    // Botón para crear nuevo turno
                    tableHTML += `<td><button class='btn' style='padding:5px; font-size:11px;' onclick="abrirFormCrearTurno('${u.name}|${u.role}', '${d.date}')">Asignar</button></td>`;
                }
            });
            tableHTML += `</tr>`;
        });
        
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    // Abre el formulario para crear un nuevo turno (pre-rellena empleado y día)
    function abrirFormCrearTurno(empleadoValor, diaFecha) {
        document.getElementById('rrhhTurnoId').value = '';
        document.getElementById('rrhhEmpleadoTurno').value = empleadoValor;
        document.getElementById('rrhhDiaTurno').value = diaFecha;
        document.getElementById('rrhhHoraInicio').value = '';
        document.getElementById('rrhhHoraFin').value = '';
        document.getElementById('rrhhTipoTurno').value = 'Normal'; // Set default
        document.getElementById('rrhhClasificacionTurno').value = 'am'; // Set default
        document.getElementById('turnos-row').style.display = 'flex'; // Show times
        document.querySelector('#formAgregarTurnoRRHH h3').innerText = 'Agregar Turno';
        toggleForm('formAgregarTurnoRRHH');
    }

    // Abre el formulario para editar un turno existente
    function abrirFormEditarTurno(turnoId) {
        const turno = planillaPublicada.find(t => t.id == turnoId);
        if (!turno) return alert('Turno no encontrado.');

        document.getElementById('rrhhTurnoId').value = turnoId;
        document.getElementById('rrhhEmpleadoTurno').value = `${turno.empleado}|${turno.cargo.toLowerCase()}`;
        document.getElementById('rrhhDiaTurno').value = turno.fecha;
        
        // Si el turno es "DÍA LIBRE"
        if(turno.inicio === 'Libre'){
            document.getElementById('rrhhTipoTurno').value = 'Libre';
            document.getElementById('turnos-row').style.display = 'none';
            document.getElementById('rrhhHoraInicio').value = '';
            document.getElementById('rrhhHoraFin').value = '';
            document.getElementById('rrhhClasificacionTurno').value = 'am';
        } else {
            document.getElementById('rrhhTipoTurno').value = 'Normal';
            document.getElementById('turnos-row').style.display = 'flex';
            document.getElementById('rrhhHoraInicio').value = turno.inicio;
            document.getElementById('rrhhHoraFin').value = turno.fin;
            document.getElementById('rrhhClasificacionTurno').value = turno.clasificacion || 'am'; // Load classification
        }
        
        document.querySelector('#formAgregarTurnoRRHH h3').innerText = 'Editar Turno';
        toggleForm('formAgregarTurnoRRHH');
    }

    // Guarda o actualiza un turno en la planilla (Gerente)
    function guardarTurnoRRHH() {
        const id = document.getElementById('rrhhTurnoId').value;
        const [empleado, cargo] = document.getElementById('rrhhEmpleadoTurno').value.split('|');
        const fecha = document.getElementById('rrhhDiaTurno').value;
        const tipoTurno = document.getElementById('rrhhTipoTurno').value;
        const clasificacionTurno = document.getElementById('rrhhClasificacionTurno').value;

        let inicio = document.getElementById('rrhhHoraInicio').value;
        let fin = document.getElementById('rrhhHoraFin').value;
        
        // Encontrar el índice del turno a editar/eliminar (si existe)
        const existingIndex = planillaPublicada.findIndex(t => t.id == id);
        
        // Lógica para "Día Libre"
        if (tipoTurno === 'Libre') {
            // Eliminar la entrada existente para ese día/empleado si ya existía
            if (existingIndex !== -1) {
                planillaPublicada.splice(existingIndex, 1);
            }
            alert('Día marcado como Libre/No Asignado (Simulado)');
            toggleForm('formAgregarTurnoRRHH');
            renderMallaRRHH();
            updateHomeDashboard();
            return;
        }

        // Si es Turno Normal, validar horas
        if (!inicio || !fin) return alert('Debes ingresar la hora de inicio y fin para un turno normal.');

        // Lógica para Turno Normal (Crear/Editar)
        if (id) {
            // Editar
            if (existingIndex !== -1) {
                planillaPublicada[existingIndex].fecha = fecha;
                planillaPublicada[existingIndex].inicio = inicio;
                planillaPublicada[existingIndex].fin = fin;
                planillaPublicada[existingIndex].empleado = empleado;
                planillaPublicada[existingIndex].cargo = ROLES[cargo];
                planillaPublicada[existingIndex].clasificacion = clasificacionTurno; // Save classification
                alert('Turno actualizado con éxito (simulado)');
            }
        } else {
            // Crear
            const nuevoTurno = {
                id: Date.now(),
                empleado,
                fecha,
                inicio,
                fin,
                cargo: ROLES[cargo],
                posicion: null, // Posición pendiente de Gerente
                clasificacion: clasificacionTurno // Save classification
            };
            planillaPublicada.push(nuevoTurno);
            alert('Nuevo turno agregado con éxito (simulado)');
        }
        
        toggleForm('formAgregarTurnoRRHH');
        renderMallaRRHH();
        updateHomeDashboard();
    }


    /* ---------- FUNCIONES MALLA / PLANILLA (Compartidas) ---------- */
    
    // Carga demo de planilla para que Gerente y Crew tengan datos
    function seedDemo(){
        const now = new Date();
        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
        const eightDaysAgo = new Date(now); eightDaysAgo.setDate(now.getDate() - 8); // Outside 7-day deadline

        // Reset de Planilla para IDs consistentes en el demo
        planillaPublicada = [
            // Crew Constanza (Operativo)
            { id: 101, empleado:'Crew Constanza', fecha:'2025-10-28', inicio:'08:00', fin:'13:00', cargo:'Crew', posicion:'Caja', clasificacion: 'am'},
            { id: 102, empleado:'Crew Constanza', fecha:'2025-10-29', inicio:'15:00', fin:'20:00', cargo:'Crew', posicion:'Cocina', clasificacion: 'pm'},
            // Crew Felipe (Operativo)
            { id: 103, empleado:'Crew Felipe', fecha:'2025-10-28', inicio:'10:00', fin:'18:00', cargo:'Crew', posicion:'Cocina', clasificacion: 'pm'},
            { id: 104, empleado:'Crew Felipe', fecha:'2025-10-31', inicio:'07:00', fin:'14:00', cargo:'Crew', posicion:null, clasificacion: 'am'}, // Sin posicion para demostrar asignación
            // Entrenador Juan (Operativo)
            { id: 105, empleado:'Entrenador Juan', fecha:'2025-10-28', inicio:'09:00', fin:'17:00', cargo:'Entrenador', posicion:'Sala', clasificacion: 'am'},
            { id: 106, empleado:'Entrenador Juan', fecha:'2025-10-30', inicio:'10:00', fin:'18:00', cargo:'Entrenador', posicion:'Automac', clasificacion: 'pm'},
            // Gerente Jefe (NO Operativo - No debe contar en Home Planilla Info)
            { id: 107, empleado:'Gerente Jefe', fecha:'2025-10-28', inicio:'07:00', fin:'15:00', cargo:'Gerente', posicion:'Oficina', clasificacion: 'am'},
        ];
        
        // Reset de Solicitudes - Agregando motivoRechazo y fechaRespuesta
        solicitudes = [
            // Solicitud de Turno (Crew -> Gerente) - PENDIENTE
            { id: 1, tipo: 'Turno', empleado: 'Crew Constanza', turnoOriginalId: 102, turnoOriginal: '2025-10-29 15:00-20:00', turnoPedido: '2025-10-29 08:00-13:00', motivo: 'Cita médica', estado: 'Pendiente', fechaSolicitud: yesterday.toISOString(), motivoRechazo: null, fechaRespuesta: null },
            // Solicitud de Posición (Entrenador -> Gerente) - RECHAZADA FUERA DE PLAZO (simulación)
            { id: 2, tipo: 'PosicionEntrenador', empleado: 'Entrenador Juan', turnoOriginalId: 105, turnoOriginal: '2025-10-28 09:00-17:00', posicionOriginal: 'Sala', posicionPedida: 'Cocina', motivo: 'Necesito práctica en Cocina', estado: 'Rechazado', fechaSolicitud: eightDaysAgo.toISOString(), motivoRechazo: 'No se aprobó por falta de cobertura en Sala.', fechaRespuesta: now.toISOString() },
            // Solicitud de Posición (Crew -> Entrenador) - APROBADA DENTRO DE PLAZO (para Crew status)
            { id: 3, tipo: 'PosicionCrew', empleado: 'Crew Constanza', turnoOriginalId: 101, turnoOriginal: '2025-10-28 08:00-13:00', posicionOriginal: 'Caja', posicionPedida: 'Automac', motivo: 'Más cómodo en Automac', estado: 'Aprobado', fechaSolicitud: yesterday.toISOString(), motivoRechazo: null, fechaRespuesta: yesterday.toISOString() },
        ];
        
        alert(`Demo cargado: ${planillaPublicada.length} turnos totales, 6 operativos y 1 solicitud pendiente.`);
        updateHomeDashboard(); // Actualiza contadores del Home
    }
    
    // NEW: Utility function to check deadline status
    function checkDeadlineStatus(fechaSolicitudStr, fechaRespuestaStr) {
        if (!fechaRespuestaStr) return 'Pendiente';

        const solicitada = new Date(fechaSolicitudStr);
        const respondida = new Date(fechaRespuestaStr);
        const deadline = new Date(solicitada);
        deadline.setDate(solicitada.getDate() + 7); // 7 days deadline

        if (respondida <= deadline) {
            return 'dentro del plazo';
        } else {
            return 'fuera del plazo';
        }
    }

    // Renderiza planilla completa (Gerente/Entrenador/RRHH)
    function renderMallaPublicada(){
        const tbody = document.querySelector('#tableMallaVisualizacion tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        const headerHtml = `
            <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <strong>Semana:</strong> ${mallaMetadata.startDate} - ${mallaMetadata.endDate}<br>
                <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            </div>`;
        document.getElementById('mallaVisualizacionHeader').innerHTML = headerHtml;
        
        const filtro = document.getElementById('filtroMallaVisualizacion').value.toLowerCase();
        
        planillaPublicada.filter(t => 
            t.empleado.toLowerCase().includes(filtro) || 
            (t.posicion && t.posicion.toLowerCase().includes(filtro)) ||
            t.fecha.includes(filtro)
        ).forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.empleado}</td><td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>${t.cargo}</td><td>${t.posicion || 'SIN POSICIÓN'}</td>`;
            tbody.appendChild(tr);
        });
    }

    /* ---------- FUNCIONES ENTRENADOR (Mis Turnos y Solicitud) ---------- */

    function renderMiPlanillaEntrenador(){
        const tbody = document.querySelector('#tableMiPlanillaEntrenador tbody');
        tbody.innerHTML = '';
        if(!currentUser) return;
        
        // Display metadata
        const headerHtml = `
              <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                  <strong>Semana:</strong> ${mallaMetadata.startDate} - ${mallaMetadata.endDate}<br>
                  <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
              </div>`;
        document.getElementById('miPlanillaEntrenadorHeader').innerHTML = headerHtml;
        
        const filtro = document.getElementById('filtroMiPlanillaEntrenador').value.toLowerCase();
        
        // Filter for current user AND role 'Entrenador'
        const mis = planillaPublicada.filter(t => 
            t.empleado.toLowerCase() === currentUser.name.toLowerCase() && 
            t.cargo === 'Entrenador' &&
            t.fecha.includes(filtro)
        );

        mis.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateMisTurnosTurnoSelectEntrenador(){
        const sel = document.getElementById('selectMisTurnosTurnoEntrenador');
        sel.innerHTML = '';
        if(!currentUser) return;
        
        // Filter for current user AND role 'Entrenador' AND not 'Libre'
        const mis = planillaPublicada.filter(t=>
            t.empleado.toLowerCase() === currentUser.name.toLowerCase() && 
            t.cargo === 'Entrenador' && 
            t.inicio !== 'Libre'
        );
        
        if(mis.length===0){
            const opt = document.createElement('option'); opt.text='(No tienes turnos de Entrenador asignados)'; opt.value=''; sel.appendChild(opt); return;
        }
        
        const defaultOpt = document.createElement('option');
        defaultOpt.text = 'Selecciona un turno a cambiar';
        defaultOpt.value = '';
        sel.appendChild(defaultOpt);
        
        mis.forEach((t,i)=>{
            const opt = document.createElement('option');
            opt.value = t.id; opt.text = `${t.fecha} - ${t.inicio} a ${t.fin} (${t.clasificacion.toUpperCase()}, Posición: ${t.posicion || 'SIN POSICIÓN'})`;
            sel.appendChild(opt);
        });
        document.getElementById('turnoOriginalInfoEntrenador').innerText = 'N/A';
    }

    function prepararSolicitudCambioTurnoEntrenador(turnoId) {
        if (!turnoId) {
            document.getElementById('turnoIdACambiarEntrenador').value = '';
            document.getElementById('turnoOriginalInfoEntrenador').innerText = 'N/A';
            return;
        }
        
        const turno = planillaPublicada.find(t => t.id == parseInt(turnoId));
        if (!turno) return;

        document.getElementById('turnoIdACambiarEntrenador').value = turnoId;
        document.getElementById('turnoOriginalInfoEntrenador').innerText = `${turno.fecha} ${turno.inicio}-${turno.fin} (${turno.clasificacion.toUpperCase()}, Posición: ${turno.posicion || 'N/A'})`;
    }

    function enviarSolicitudTurnoEntrenador() {
        if(!currentUser) return alert('Debes iniciar sesión.');
        if(currentUser.role !== 'entrenador') return alert('Solo los Entrenadores pueden usar esta función.');

        const turnoId = document.getElementById('turnoIdACambiarEntrenador').value;
        if(!turnoId) return alert('Selecciona un turno válido para el cambio.');

        const turnoOriginal = planillaPublicada.find(t => t.id == turnoId);
        if(!turnoOriginal || turnoOriginal.cargo !== 'Entrenador') return alert('Turno original no válido o no es un turno de Entrenador.');

        const sugFecha = document.getElementById('sugFechaEntrenador').value;
        const sugInicio = document.getElementById('sugInicioEntrenador').value;
        const sugFin = document.getElementById('sugFinEntrenador').value;
        const motivo = document.getElementById('motivoCambioEntrenador').value.trim();
        
        if(!sugFecha||!sugInicio||!sugFin||!motivo) return alert('Completa todos los campos de la solicitud de Turno.');
        
        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'Turno', 
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), 
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            turnoPedido: `${sugFecha} ${sugInicio}-${sugFin}`,
            motivo: motivo,
            motivoRechazo: null,
            fechaRespuesta: null
        };
        
        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioTurnoEntrenadorWrapper').querySelector('form').reset();
        updateHomeDashboard();
        alert(`Solicitud de Turno enviada con éxito al Gerente (simulado)`);
        nav('misTurnosYCambioEntrenador'); 
    }
    
    /* ---------- FUNCIONES GERENTE (Planif. Posiciones) ---------- */
    
    // Renderiza la planilla para la planificación de posiciones (Gerente)
    function renderPlanifPosiciones(){
        const tbody = document.querySelector('#tablePlanifPosiciones tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroPlanifPosiciones').value.toLowerCase();
        
        planillaPublicada.filter(t => (t.cargo === 'Crew' || t.cargo === 'Entrenador') && (
            t.empleado.toLowerCase().includes(filtro) ||
            (t.posicion && t.posicion.toLowerCase().includes(filtro)) ||
            t.fecha.includes(filtro)
        )).forEach(t=>{
            const tr = document.createElement('tr');
            const posicionDisplay = t.posicion || 'PENDIENTE';
            tr.innerHTML = `<td>${t.empleado}</td><td>${t.fecha}</td><td>${t.inicio} - ${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${posicionDisplay}**</td><td class='actions'>
                <button class='btn btn-sec' onclick='asignarPosicion(${t.id}, "${t.empleado}", "${t.fecha}")'>Asignar/Editar Posición</button>
                <button class='btn' onclick='eliminarPosicion(${t.id})'>Eliminar</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    
    // Asigna/Edita posición (Gerente) - Actualiza el valor real
    function asignarPosicion(id, empleado, fecha){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        const currentPosicion = planillaPublicada[turnoIndex].posicion || '';
        
        const newPosicion = prompt(`Nueva posición para ${empleado} (${fecha}, Turno ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}):`, currentPosicion);

        if (newPosicion === null) {
            return;
        }

        if (newPosicion.trim() === '') {
             if (currentPosicion) {
                // Si el usuario borra la posición existente
                planillaPublicada[turnoIndex].posicion = null;
                alert('Posición eliminada/reseteada.');
                renderPlanifPosiciones();
            }
            return;
        }

        // Actualizar la posición
        planillaPublicada[turnoIndex].posicion = newPosicion.trim();
        alert(`Posición actualizada a **${newPosicion.trim()}** para ${empleado}.`);
        renderPlanifPosiciones();
    }

    // Elimina posición (Gerente) - Pone el valor en null
    function eliminarPosicion(id){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        if (confirm(`¿Eliminar la posición de ${planillaPublicada[turnoIndex].empleado} para el turno ${planillaPublicada[turnoIndex].fecha} ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}?`)) {
            planillaPublicada[turnoIndex].posicion = null;
            alert('Posición eliminada.');
            renderPlanifPosiciones();
        }
    }


    // Renderiza planilla personal (Crew)
    function renderMiPlanilla(){
      const tbody = document.querySelector('#tableMiPlanilla tbody');
      tbody.innerHTML = '';
      if(!currentUser) return;
      
      const headerHtml = `
            <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <strong>Semana:</strong> ${mallaMetadata.startDate} - ${mallaMetadata.endDate}<br>
                <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            </div>`;
        document.getElementById('miPlanillaHeader').innerHTML = headerHtml;
      
      const filtro = document.getElementById('filtroMiPlanilla').value.toLowerCase();
        
      const mis = planillaPublicada.filter(t => t.empleado.toLowerCase() === currentUser.name.toLowerCase() && t.fecha.includes(filtro));

      mis.forEach(t=>{
        const tr = document.createElement('tr');
        // Se eliminó la columna "Acción"
        tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
        tbody.appendChild(tr);
      })
    }
    
    // Prepara la info del turno a cambiar (usado por la nueva sección de Crew)
    function prepararSolicitudCambioTurno(turnoId) {
        if (!turnoId) {
            document.getElementById('turnoIdACambiar').value = '';
            document.getElementById('turnoOriginalInfo').innerText = 'N/A';
            return;
        }
        
        const turno = planillaPublicada.find(t => t.id == parseInt(turnoId));
        if (!turno) return;

        // Rellenar la información del turno a cambiar
        document.getElementById('turnoIdACambiar').value = turnoId;
        document.getElementById('turnoOriginalInfo').innerText = `${turno.fecha} ${turno.inicio}-${turno.fin} (${turno.clasificacion.toUpperCase()}, Posición: ${turno.posicion || 'N/A'})`;
    }


    /* ---------- FUNCIONES SOLICITUDES (Crew/Entrenador -> Gerente) ---------- */
    
    // Llena el select de turnos disponibles para cambio de TURNO (Crew)
    function populateMisTurnosTurnoSelect(){
        const sel = document.getElementById('selectMisTurnosTurno');
        sel.innerHTML = '';
        if(!currentUser) return;
        
        // Filtra solo turnos con horas asignadas (no días libres)
        const mis = planillaPublicada.filter(t=>t.empleado.toLowerCase() === currentUser.name.toLowerCase() && t.inicio !== 'Libre');
        
        if(mis.length===0){
            const opt = document.createElement('option'); opt.text='(No tienes turnos asignados)'; opt.value=''; sel.appendChild(opt); return;
        }
        
        const defaultOpt = document.createElement('option');
        defaultOpt.text = 'Selecciona un turno a cambiar';
        defaultOpt.value = '';
        sel.appendChild(defaultOpt);
        
        mis.forEach((t,i)=>{
            const opt = document.createElement('option');
            opt.value = t.id; opt.text = `${t.fecha} - ${t.inicio} a ${t.fin} (${t.clasificacion.toUpperCase()}, Posición: ${t.posicion || 'SIN POSICIÓN'})`;
            sel.appendChild(opt);
        });
        document.getElementById('turnoOriginalInfo').innerText = 'N/A';
    }

    
    // Llena el select de TODOS los turnos para cambio de POSICIÓN (Entrenador)
    function populateTurnosAllSelect(){
      const sel = document.getElementById('selectTodosLosTurnos');
      sel.innerHTML = '';
      
      // Entrenador puede cambiar la posición de CUALQUIER turno operativo (Crew/Entrenador) que tenga horario.
      const todosOperativos = planillaPublicada.filter(t => (t.cargo === 'Crew' || t.cargo === 'Entrenador') && t.inicio !== 'Libre');
      
      if(todosOperativos.length===0){
        const opt = document.createElement('option'); opt.text='(No hay turnos operativos publicados)'; opt.value=''; sel.appendChild(opt); return;
      }
      
      todosOperativos.forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.id; opt.text = `${t.empleado} (${t.cargo}) - ${t.fecha} ${t.inicio}-${t.fin} (Posición: ${t.posicion || 'N/A'})`;
        sel.appendChild(opt);
      })
    }

    // Enviar solicitud de Turno (Crew)
    function enviarSolicitudTurno() {
        if(!currentUser) return alert('Debes iniciar sesión.');

        const turnoId = document.getElementById('turnoIdACambiar').value;
        if(!turnoId) return alert('Selecciona un turno válido para el cambio.');

        const turnoOriginal = planillaPublicada.find(t => t.id == turnoId);
        if(!turnoOriginal) return alert('Turno original no válido.');

        const sugFecha = document.getElementById('sugFecha').value;
        const sugInicio = document.getElementById('sugInicio').value;
        const sugFin = document.getElementById('sugFin').value;
        const motivo = document.getElementById('motivoCambio').value.trim();
        
        if(!sugFecha||!sugInicio||!sugFin||!motivo) return alert('Completa todos los campos de la solicitud de Turno.');
        
        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'Turno', 
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), // NEW: Save as ISO string
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            turnoPedido: `${sugFecha} ${sugInicio}-${sugFin}`,
            motivo: motivo,
            motivoRechazo: null,
            fechaRespuesta: null
        };
        
        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioTurno').querySelector('form').reset();
        updateHomeDashboard();
        alert(`Solicitud de Turno enviada con éxito al Gerente (simulado)`);
        nav('miPlanilla'); // Redirección a su planilla
    }
    
    // Wrapper para enviar solicitud (solo maneja Turno ya que Posición Crew fue eliminada)
    function enviarSolicitud(tipo) {
        if (tipo === 'Turno') return enviarSolicitudTurno(); 
    }
    
    // Enviar solicitud de Posicion (Entrenador - Todos los turnos)
    function enviarSolicitudEntrenadorPosicionAll() {
        if(!currentUser) return alert('Debes iniciar sesión.');
        
        const sel = document.getElementById('selectTodosLosTurnos');
        if(!sel.value) return alert('Selecciona un turno válido para el cambio.');

        const turnoOriginal = planillaPublicada.find(t => t.id == parseInt(sel.value));
        
        const posicionPedida = document.getElementById('posicionPedidaAll').value.trim();
        const motivo = document.getElementById('motivoCambioPosAll').value.trim();
        
        if(!posicionPedida||!motivo) return alert('Completa todos los campos de la solicitud de Posición.');

        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'PosicionEntrenador', // Tipo para que lo revise el Gerente
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), // NEW: Save as ISO string
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            posicionOriginal: turnoOriginal.posicion,
            posicionPedida,
            motivo,
            empleadoAfectado: turnoOriginal.empleado, // Nuevo campo para saber quién es el dueño del turno
            motivoRechazo: null,
            fechaRespuesta: null
        };

        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioPosicionAll').querySelector('form').reset();
        
        updateHomeDashboard();
        alert(`Solicitud de Posición (Global) enviada con éxito al Gerente (simulado)`);
        nav('historialPosicion'); // Redirige a su historial de solicitudes
    }

    // Renderiza solicitudes para Gerente (Turno) o Gerente (PosicionEntrenador)
    function renderSolicitudes(tipo){
      let tbodyId;
      if (tipo === 'Turno') tbodyId = '#tableSolicitudesTurno tbody';
      else if (tipo === 'PosicionEntrenador') tbodyId = '#tableSolicitudesPosicion tbody';
      else return;
      
      const tbody = document.querySelector(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = '';
      
      const filteredSolicitudes = solicitudes.filter(s => s.tipo === tipo);

      filteredSolicitudes.forEach(s=>{
        const tr = document.createElement('tr');
        
        const fechaSolicitud = new Date(s.fechaSolicitud).toLocaleDateString('es-CL'); // NEW: Formatted date
        
        // NEW: Estado con plazo
        let estadoDisplay = s.estado;
        if (s.estado !== 'Pendiente') {
            const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
            estadoDisplay = `${s.estado} (${status})`;
        }
        
        let empleadoCol = s.empleado;
        let detalles;
        
        if (tipo === 'Turno') {
          // Add Fecha de Solicitud to table
          detalles = `<td>${empleadoCol}</td><td>${fechaSolicitud}</td><td>${s.turnoOriginal}</td><td>${s.turnoPedido}</td><td>${s.motivo}</td>`;
        } else { // PosicionEntrenador
          // Add Fecha de Solicitud to table
          if (s.empleado !== s.empleadoAfectado) {
             empleadoCol = `${s.empleado} (Para: ${s.empleadoAfectado})`;
          }
          detalles = `<td>${empleadoCol}</td><td>${fechaSolicitud}</td><td>${s.turnoOriginal}</td><td>${s.posicionOriginal || 'N/A'}</td><td>${s.posicionPedida}</td><td>${s.motivo}</td>`;
        }
        
        // Columna de Estado/Acciones
        const estadoHTML = `<span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>`;
        let accionesHTML = s.estado === 'Pendiente' ? 
            `<button class='btn btn-approve' onclick='aprobarSolicitud(${s.id}, "${tipo}")'>Aprobar</button>
            <button class='btn btn-reject' onclick='rechazarSolicitud(${s.id}, "${tipo}")'>Rechazar</button>` 
            : s.estado;

        // The structure of the row needs to be adjusted based on the new table headers
        // Since both tables start with Empleado and Fecha Solicitud, we can use the 'detalles'
        tr.innerHTML = `${detalles}<td>${estadoHTML}</td><td class='actions'>${accionesHTML}</td>`;
        tbody.appendChild(tr);
      })
    }

    // Lógica para APROBAR solicitud (Simulada, no actualiza planilla)
    function aprobarSolicitud(id, tipo){
      const s = solicitudes.find(x=>x.id===id); if(!s) return;
      
      if(!confirm(`¿Aprobar solicitud de ${tipo}? (Simulado - NOTA: La planilla no se actualiza en este mockup)`)) return;
      
      s.estado = 'Aprobado';
      s.fechaRespuesta = new Date().toISOString(); // NEW: Record response date
      s.motivoRechazo = null; // Limpiar motivo de rechazo si es aprobado
      renderSolicitudes(tipo);
      updateHomeDashboard(); // Actualizar el dashboard si estamos en home
    }
    
    // Lógica para RECHAZAR solicitud (Ahora pide un comentario)
    function rechazarSolicitud(id, tipo){
      const s = solicitudes.find(x=>x.id===id); if(!s) return;
      
      const promptTitle = `Rechazar solicitud de ${tipo}. Ingresa un comentario para el empleado:`;
      const motivoRechazo = prompt(promptTitle);
      
      if (motivoRechazo === null || motivoRechazo.trim() === '') {
          // Si presiona cancelar o deja vacío y acepta
          if (motivoRechazo !== null) alert('Debes ingresar un motivo de rechazo.');
          return;
      }
      
      s.estado = 'Rechazado';
      s.motivoRechazo = motivoRechazo.trim();
      s.fechaRespuesta = new Date().toISOString(); // NEW: Record response date
      
      renderSolicitudes(tipo);
      updateHomeDashboard(); // Actualizar el dashboard si estamos en home
    }

    // Renderiza el estado de las solicitudes para el Crew
    function renderEstadoSolicitudes(){
        const tbody = document.querySelector('#tableEstadoSolicitudes tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        // Filtra solo las solicitudes de Turno para Crew (ya que PosicionCrew fue eliminada)
        const mine = currentUser ? solicitudes.filter(s=>s.empleado.toLowerCase()===currentUser.name.toLowerCase() && s.tipo === 'Turno') : [];
        
        mine.forEach(s=>{
            let detalle = `<td>${s.turnoOriginal}</td><td>Turno: ${s.turnoPedido}</td>`;
            
            // NEW: Estado con plazo
            let estadoDisplay = s.estado;
            if (s.estado !== 'Pendiente') {
                const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
                estadoDisplay = `${s.estado} (${status})`;
            }

            let comentarioRechazo = '';
            if (s.estado === 'Rechazado' && s.motivoRechazo) {
                comentarioRechazo = `<div class="muted" style="margin-top:5px; color:var(--mc-red); font-weight: 600;">Motivo de Rechazo: ${s.motivoRechazo}</div>`;
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.tipo.replace('Posicion', 'Pos.')}</td>${detalle}<td><span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>${comentarioRechazo}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Renderiza el historial de turnos (Crew)
    function renderHistorial(){
        const tbody = document.querySelector('#tableHistorial tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroHistorial').value.toLowerCase();

        // En un sistema real, sería una vista filtrada por fecha. Aquí usamos la planilla actual.
        const misTurnosHist = planillaPublicada.filter(t=>t.empleado.toLowerCase()===currentUser.name.toLowerCase() && t.fecha.includes(filtro));

        misTurnosHist.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
            tbody.appendChild(tr);
        });
    }
    
    // Renderiza el historial de solicitudes de posición (Entrenador) - Renombrado a "Estado de Solicitudes (Mías)"
    function renderHistorialPosicion() {
        const tbody = document.querySelector('#tableHistorialPosicion tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Filtra solo solicitudes de posición realizadas por el Entrenador (tipo 'PosicionEntrenador')
        const mine = currentUser ? solicitudes.filter(s => s.tipo === 'PosicionEntrenador' && s.empleado.toLowerCase() === currentUser.name.toLowerCase()) : [];

        mine.forEach(s => {
            let comentarioRechazo = '';
            if (s.estado === 'Rechazado' && s.motivoRechazo) {
                comentarioRechazo = `<div class="muted" style="margin-top:5px; color:var(--mc-red); font-weight: 600;">Motivo de Rechazo: ${s.motivoRechazo}</div>`;
            }

            // NEW: Estado con plazo
            let estadoDisplay = s.estado;
            if (s.estado !== 'Pendiente') {
                const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
                estadoDisplay = `${s.estado} (${status})`;
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(s.fechaSolicitud).toLocaleDateString('es-CL')}</td><td>${s.turnoOriginal}</td><td>${s.posicionPedida}</td><td><span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>${comentarioRechazo}</td>`;
            tbody.appendChild(tr);
        });
    }

    /* ---------- FUNCIONES ADMIN (Gestión de Usuarios) ---------- */

    function guardarUsuarioAdmin() {
        const name = document.getElementById('adminNewName').value.trim();
        const user = document.getElementById('adminNewUser').value.trim();
        const pass = document.getElementById('adminNewPass').value.trim();
        const role = document.getElementById('adminNewRole').value;

        if (!name || !user || !pass || !role) {
            return alert('Todos los campos son obligatorios para crear un usuario.');
        }

        if (allUsers.some(u => u.user === user)) {
            return alert('El usuario (login) ya existe. Intente con otro.');
        }

        const newUser = {
            name: name,
            role: role,
            user: user,
            pass: pass
        };

        allUsers.push(newUser);
        alert(`Usuario "${name}" (${ROLES[role]}) creado con éxito.`);
        
        // Reset form and re-render table
        document.getElementById('adminUserForm').reset();
        toggleForm('formCrearUsuario');
        renderTablaUsuarios();
    }
    
    /* ---------- FUNCIONES GERENTE (Creación de Malla) ---------- */

    // Replicando funciones para Gerente (necesarias para evitar la eliminación al final)
    
    function guardarTurnoRRHH() {
        const id = document.getElementById('rrhhTurnoId').value;
        const [empleado, cargo] = document.getElementById('rrhhEmpleadoTurno').value.split('|');
        const fecha = document.getElementById('rrhhDiaTurno').value;
        const tipoTurno = document.getElementById('rrhhTipoTurno').value;
        const clasificacionTurno = document.getElementById('rrhhClasificacionTurno').value;

        let inicio = document.getElementById('rrhhHoraInicio').value;
        let fin = document.getElementById('rrhhHoraFin').value;
        
        const existingIndex = planillaPublicada.findIndex(t => t.id == id);
        
        if (tipoTurno === 'Libre') {
            if (existingIndex !== -1) {
                planillaPublicada.splice(existingIndex, 1);
            }
            alert('Día marcado como Libre/No Asignado (Simulado)');
            toggleForm('formAgregarTurnoRRHH');
            renderMallaRRHH();
            updateHomeDashboard();
            return;
        }

        if (!inicio || !fin) return alert('Debes ingresar la hora de inicio y fin para un turno normal.');

        if (id) {
            if (existingIndex !== -1) {
                planillaPublicada[existingIndex].fecha = fecha;
                planillaPublicada[existingIndex].inicio = inicio;
                planillaPublicada[existingIndex].fin = fin;
                planillaPublicada[existingIndex].empleado = empleado;
                planillaPublicada[existingIndex].cargo = ROLES[cargo];
                planillaPublicada[existingIndex].clasificacion = clasificacionTurno;
                alert('Turno actualizado con éxito (simulado)');
            }
        } else {
            const nuevoTurno = {
                id: Date.now(),
                empleado,
                fecha,
                inicio,
                fin,
                cargo: ROLES[cargo],
                posicion: null,
                clasificacion: clasificacionTurno
            };
            planillaPublicada.push(nuevoTurno);
            alert('Nuevo turno agregado con éxito (simulado)');
        }
        
        toggleForm('formAgregarTurnoRRHH');
        renderMallaRRHH();
        updateHomeDashboard();
    }


    // Al iniciar, mostrar login
    nav('login');
  </script>
</body>
</html>
