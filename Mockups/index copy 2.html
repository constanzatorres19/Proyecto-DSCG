<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mockups SCT - McDonald's</title>
  <style>
    /* ==========================================
      Estilos globales - Paleta McDonald's
      ========================================== */
    :root{
      --mc-red: #D91D0E;
      --mc-yellow: #FFC300;
      --mc-dark: #222;
      --mc-light: #f7f7f7;
      --card-radius:16px;
      --gap:14px;
      font-family: Inter, system-ui, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg, var(--mc-yellow) 0%, var(--mc-yellow) 50%, #ffffff 100%);}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}

    /* Contenedor principal */
    .frame{width:100%;max-width:1300px;background:white;border-radius:18px;padding:18px;box-shadow:0 6px 28px rgba(0,0,0,0.12); border: 4px solid var(--mc-red);}

    /* --- Nuevo Diseño de Encabezado --- */
    /* El .app ya no centra verticalmente para las pantallas de rol */
    .app.logged-in {
      align-items: flex-start; /* Alinear arriba cuando está logueado */
      padding-top: 0;
      padding-bottom: 20px;
    }
    .app.logged-in .frame {
      padding-bottom: 30px; /* Espacio extra en el fondo */
      min-height: calc(100vh - 40px);
    }
    .app:not(.logged-in) .frame {
      min-width: 400px; /* Ancho mínimo para la vista de login */
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee; /* Separador */
    }
    .brand{display:flex;align-items:center;gap:12px}

    /* Logo Placeholder Style */
    .logo-container {
      width: 50px; height: 50px;
      background: transparent;
      border: 3px solid var(--mc-yellow);
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 30px; font-weight: 900; color: var(--mc-red);
      line-height: 0;
      box-shadow: 0 0 0 5px var(--mc-red);
    }
    /* Estilo para si el usuario usa una imagen */
    .logo-img { width: 50px; height: auto; }

    h1{font-size:24px;margin:0;color:var(--mc-dark)}
    h2{color: var(--mc-red);}
    .role-badge{background:var(--mc-red);color:white;padding:8px 12px;border-radius:999px;font-weight:600}

    /* Layout principal - columnas */
    .container{display:grid;grid-template-columns:250px 1fr;gap:18px}
    /* Para el login, centrar el main en el frame */
    .app:not(.logged-in) .container {
      display: flex;
      justify-content: center;
    }
    .app:not(.logged-in) .sidebar {
      display: none;
    }
    .app:not(.logged-in) .main {
      width: 100%;
      max-width: 400px;
      margin-top: 30px;
    }

    /* Sidebar / menú */
    .sidebar{background:var(--mc-light);border-radius:12px;padding:12px;border:2px solid rgba(0,0,0,0.08)}
    .side-block{display:flex;flex-direction:column;gap:15px} /* Aumentado a 15px para más separación entre bloques */
    
    /* Para separar los botones dentro de cada bloque de rol */
    #menuAdmin, #menuRRHH, #menuGerente, #menuEntrenador, #menuCrew {
      display: flex;
      flex-direction: column;
      gap: 30px; /* MODIFICADO: Aumentado el gap a 30px para asegurar la separación */
    }
    
    /* Eliminar/Ajustar espacio entre HOME y botones de rol (usar gap de side-block) */
    .side-block > .menu-btn { margin-bottom: 0; }
    
    button.menu-btn, .btn-primary{background:var(--mc-red);color:white;border:none;padding:10px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-sec{background:var(--mc-yellow);color:var(--mc-dark);border:none;}
    .small{font-size:13px;color:#333}

    /* Main content area */
    .main{background:#fff;border-radius:12px;padding:14px;min-height:460px;border:2px solid rgba(0,0,0,0.03)}
    .screen{display:none}
    .screen.active{display:block}
    
    /* Para formularios más anchos en las pantallas logueadas */
    .app.logged-in form {
      max-width: 600px;
      margin: 0 auto; /* Centrar formularios */
    }
    .app.logged-in .main h2 {
      text-align: center;
      margin-top: 0;
    }
    .app.logged-in .main .muted:first-of-type {
      text-align: center;
      margin-bottom: 20px;
    }


    /* Formularios y tablas */
    form{display:flex;flex-direction:column;gap:10px}
    label{font-weight:600;font-size:13px}
    input[type="text"], input[type="time"], input[type="date"], input[type="password"], select, textarea{padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px; background: #fff;}
    textarea{min-height:80px}
    .row{display:flex;gap:10px}
    .row .col{flex:1}
    /* Para botones auto en la fila */
    .row .col-auto {
      flex: 0 0 auto;
    }
    .muted{color:#666;font-size:13px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:var(--mc-light);font-weight: 700;}

    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-sec{background:var(--mc-yellow)}
    .btn-approve { background: #4CAF50; color: white; }
    .btn-reject { background: var(--mc-red); color: white; }

    /* Estados de Solicitud */
    .estado-aprobado { color: green; font-weight: bold; }
    .estado-rechazado { color: var(--mc-red); font-weight: bold; }
    .estado-pendiente { color: #8a6d3b; background: #fcf8e3; padding: 3px 6px; border-radius: 5px; font-size: 12px; border: 1px solid #faebcc;} /* Nuevo estilo de pendiente */

    /* Contenedores específicos */
    .grid-malla { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-top: 15px; }
    .day-header { background: var(--mc-red); color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px 5px 0 0; }
    .turno-box { background: var(--mc-yellow); padding: 5px; border-radius: 5px; font-size: 12px; text-align: center; margin-bottom: 5px; cursor: pointer; }
    .turno-box.pendiente { border: 2px dashed #f0ad4e; } /* Para turnos nuevos o editados */
    .turno-libre { background: #aaa; color: #fff; padding: 5px; border-radius: 5px; font-size: 12px; text-align: center; margin-bottom: 5px; }

    /* Estilos para KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
    .kpi-card { padding: 15px; border-radius: 12px; background: var(--mc-light); border: 1px solid #ddd; }
    .kpi-value { font-size: 32px; font-weight: bold; margin: 5px 0; }
    .kpi-status { padding: 5px 10px; border-radius: 8px; font-weight: bold; display: inline-block; margin-top: 10px; font-size: 14px; }
    .kpi-status.expected { background: #f0ad4e; color: #333; }
    .kpi-status.better { background: #4CAF50; color: white; }
    .kpi-status.deficient { background: var(--mc-red); color: white; }
    .kpi-detail-table { width: 100%; margin-top: 10px; font-size: 12px; }
    .kpi-detail-table td { padding: 2px 0; border-bottom: none; }
    .kpi-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #eee; }


    /* Responsivo */
    @media(max-width:900px){
      .container{grid-template-columns:1fr}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="frame">

      <header>
        <div class="brand">
          <img src="logo_mc.png" alt="McDonald's Logo" class="logo-img">
          <div>
            <h1>Sistema de Control de Turnos McDonald's</h1>
            <div class="muted">Diseño de Mockup Funcional - 5 Roles</div>
          </div>
        </div>
        <div id="headerRole" class="role-badge">Rol: Invitado</div>
      </header>

      <div class="container">

        <aside class="sidebar">
          <div class="side-block">
            <div id="userBox">
              <div class="muted">Usuario:</div>
              <div id="userName" style="font-weight:700">(no has iniciado sesión)</div>
            </div>
            
            <button id="homeButton" class="menu-btn" style="display:none" onclick="nav('home')">Home</button>

            <div id="menuAdmin" style="display:none">
              <button class="btn btn-sec" onclick="nav('gestionUsuarios')">Gestión de Usuarios</button>
            </div>
            
            <div id="menuRRHH" style="display:none">
              <button class="btn btn-sec" onclick="nav('visualizarMalla')">Malla Horaria Publicada</button>
              <button class="btn btn-sec" onclick="nav('kpisRRHH')">Panel de KPIs</button>
            </div>
            
            <div id="menuGerente" style="display:none">
              <button class="btn btn-sec" onclick="nav('planificarRRHH')">Crear/Editar Malla Horaria</button>
              <button class="btn btn-sec" onclick="nav('planificarPosiciones')">Asignar Posiciones Operativas</button>
              <button class="btn btn-sec" onclick="nav('revisarSolicitudesTurno')">Solicitudes de Cambio de Turno</button>
              <button class="btn btn-sec" onclick="nav('revisarSolicitudesPosicion')">Solicitudes de Posición (Entr.)</button>
            </div>
            
            <div id="menuEntrenador" style="display:none">
              <button class="btn btn-sec" onclick="nav('visualizarMalla')">Malla con Posiciones</button>
              <button class="btn btn-sec" onclick="nav('misTurnosYCambioEntrenador')">Mis Turnos y Solicitud de Cambio</button>
              <button class="btn btn-sec" onclick="nav('solicitarCambioPosicionAll')">Solicitar Cambio de Posición (Todos)</button>
              <button class="btn btn-sec" onclick="nav('historialPosicion')">Estado de Solicitudes (Mías)</button>
            </div>
            
            <div id="menuCrew" style="display:none">
              <button class="btn btn-sec" onclick="nav('miPlanilla')">Mi Horario y Posición</button>
              <button class="btn btn-sec" onclick="nav('solicitarCambioTurno')">Solicitar Cambio de Turno</button>
              <button class="btn btn-sec" onclick="nav('estadoSolicitudes')">Estado de Solicitudes</button>
              <button class="btn btn-sec" onclick="nav('historial')">Historial de Turnos</button>
            </div>

            <div style="margin-top:10px">
              <button class="btn" id="btnLogout" style="display:none" onclick="logout()">Cerrar sesión</button>
              <button class="btn btn-primary" id="btnLogin" onclick="nav('login')">Iniciar sesión</button>
            </div>
            
            <div style="margin-top:18px" class="muted">Tips de Prueba:</div>
            <div class="muted" style="font-size:12px">
              Usuario/Contraseña: `demo`/`1234`<br>
              Roles a probar: `admin`, `rrhh`, `gerente`, `entrenador`, `crew`.
            </div>
          </div>
        </aside>

        <main class="main">

          <section id="login" class="screen active">
            <h2>Login de Acceso</h2>
            <p class="muted">Ingresa tu usuario, contraseña y rol para acceder al sistema.</p>
            <form onsubmit="event.preventDefault(); doLogin()">
              <label>Usuario</label>
              <input id="loginUsuario" type="text" placeholder="Ej: demo" required>
              
              <label>Contraseña</label>
              <input id="loginPass" type="password" placeholder="Ej: 1234" required>

              <label>Rol</label>
              <select id="loginRol">
                <option value="admin">Admin</option>
                <option value="rrhh">RR.HH.</option>
                <option value="gerente">Gerente</option>
                <option value="entrenador">Entrenador</option>
                <option value="crew">Crew</option>
              </select>

              <div class="row">
                <div class="col">
                  <button class="btn btn-primary" type="submit">Ingresar</button>
                </div>
                <div class="col">
                  <button class="btn btn-sec" type="button" onclick="seedDemo()">Cargar Demo</button>
                </div>
              </div>
            </form>
          </section>

          <section id="home" class="screen">
            <h2>Home (Gerente)</h2>
            <div class="muted">Bienvenido a tu panel de control. Usa el menú lateral para gestionar tus tareas.</div>
            <div style="margin-top:12px">
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1;min-width:220px;background:var(--mc-light);padding:12px;border-radius:10px">
                  <strong>Planilla publicada:</strong>
                  <div id="homePlanillaInfo" class="muted">Sin datos cargados</div>
                </div>
                <div style="flex:1;min-width:220px;background:var(--mc-light);padding:12px;border-radius:10px">
                  <strong>Solicitudes pendientes:</strong>
                  <div id="homeSolicitudesInfo" class="muted">0</div>
                </div>
              </div>
            </div>
          </section>

          <section id="gestionUsuarios" class="screen">
            <h2>Gestión de Usuarios (Admin)</h2>
            <button class="btn btn-primary" onclick="toggleForm('formCrearUsuario')">Crear Nuevo Usuario</button>
            <p class="muted">El Admin puede crear, editar y eliminar cualquier usuario del sistema.</p>

            <div id="formCrearUsuario" style="display:none; border:1px solid #ddd; padding:15px; border-radius:10px; margin-top:10px;">
                <h3>Crear/Editar Usuario</h3>
                <form id="adminUserForm" onsubmit="event.preventDefault(); guardarUsuarioAdmin()">
                    <label>Nombre Completo</label><input type="text" id="adminNewName" placeholder="Nombre Apellido">
                    <label>Usuario (Login)</label><input type="text" id="adminNewUser" placeholder="user.login">
                    <label>Contraseña</label><input type="password" id="adminNewPass" placeholder="********">
                    <label>Rol</label>
                    <select id="adminNewRole">
                        <option value="crew">Crew</option><option value="gerente">Gerente</option><option value="admin">Admin</option><option value="rrhh">RR.HH.</option><option value="entrenador">Entrenador</option>
                    </select>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" type="submit">Guardar Usuario</button>
                        <button class="btn" type="button" onclick="toggleForm('formCrearUsuario')">Cancelar</button>
                    </div>
                </form>
            </div>

            <h3 style="margin-top: 20px;">Listado de Usuarios</h3>
            <input type="text" id="filtroUsuarios" placeholder="Buscar por Nombre o Rol..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderTablaUsuarios()">
            <table id="tableUsuarios">
                <thead><tr><th>Nombre</th><th>Rol</th><th>Usuario</th><th>Última Modif.</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
          </section>
          
          <section id="kpisRRHH" class="screen">
            <h2>Panel de Indicadores Clave (RR.HH.)</h2>
            <p class="muted">Reporte de desempeño **Noviembre 2025** (${mallaMetadata.startDate} - ${mallaMetadata.endDate}).</p>
            
            <div class="kpi-section">
                <h3>KPI 1: Tasa de Carga Personal</h3>
                <p class="muted">Mide la proporción de empleados operativos en turno (Promedio Diario). Objetivo: 8%.</p>
                <div id="kpi1Container" class="kpi-grid">
                    </div>
            </div>

            <div class="kpi-section">
                <h3>KPI 2 y KPI 3: Estabilidad y Oportunidad</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="kpiTimeframe">Periodo de Medición:</label>
                    <select id="kpiTimeframe" onchange="renderKpisRRHH()">
                        <option value="month">Mensual (Total)</option>
                        <option value="week">Semanal (Promedio)</option>
                        <option value="day">Diario (Promedio)</option>
                    </select>
                </div>

                <div id="kpi2kpi3Container" class="kpi-grid">
                    </div>
            </div>
            
          </section>
          <section id="planificarRRHH" class="screen">
            <h2>Creación de Malla Horaria Semanal (Gerente)</h2>
            <p class="muted">Planifique los turnos por empleado. Usted (Gerente) puede añadir las posiciones después.</p>

            <form onsubmit="event.preventDefault(); toggleForm('formAgregarTurnoRRHH')">
                <div class="row">
                    <div class="col">
                        <label>Inicio de Semana</label><input type="date" id="rrhhSemanaInicio" value="2025-10-28">
                    </div>
                    <div class="col">
                        <label>Fin de Semana</label><input type="date" id="rrhhSemanaFin" value="2025-11-03">
                    </div>
                </div>
                <div class="row" style="margin-bottom: 10px; margin-top: 10px;">
                    <div class="col-auto"><button class="btn btn-primary" type="button" onclick="alert('Malla publicada. Gerente puede añadir posiciones.')">Publicar Malla</button></div>
                    <div class="col-auto"><button class="btn" type="submit">Agregar Turno Manual</button></div>
                </div>
            </form>
            
            <div id="formAgregarTurnoRRHH" style="display:none; border:1px solid #ddd; padding:15px; border-radius:10px; margin-top:10px;">
                <h3>Agregar/Editar Turno</h3>
                <form onsubmit="event.preventDefault(); guardarTurnoRRHH();">
                    <label>Empleado</label>
                    <select id="rrhhEmpleadoTurno">
                        </select>
                    <label>Día del Turno</label>
                    <select id="rrhhDiaTurno">
                        </select>
                    
                    <label>Clasificación de Turno</label>
                    <select id="rrhhClasificacionTurno">
                        <option value="am">AM (Mañana)</option>
                        <option value="pm">PM (Tarde)</option>
                        <option value="nocturno">Nocturno</option>
                    </select>

                    <label>Tipo de Turno</label>
                    <select id="rrhhTipoTurno" onchange="document.getElementById('turnos-row').style.display = (this.value === 'Libre') ? 'none' : 'flex'">
                        <option value="Normal">Turno Normal (Horas)</option>
                        <option value="Libre">Día Libre (No Asignar Turno)</option>
                    </select>

                    <div class="row" id="turnos-row">
                        <div class="col">
                            <label>Hora Inicio</label><input type="time" id="rrhhHoraInicio">
                        </div>
                        <div class="col">
                            <label>Hora Fin</label><input type="time" id="rrhhHoraFin">
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" type="submit">Guardar Turno</button>
                        <button class="btn" type="button" onclick="toggleForm('formAgregarTurnoRRHH')">Cancelar</button>
                    </div>
                    <input type="hidden" id="rrhhTurnoId" value="">
                </form>
            </div>

            <h3 style="margin-top: 20px;">Vista Semanal (Simulación)</h3>
            <div id="rrhhMallaContainer">
                <p class="muted">Cargando malla...</p>
            </div>
          </section>

          <section id="revisarSolicitudesTurno" class="screen">
            <h2>Solicitudes de Cambio de Turno Pendientes (Gerente)</h2>
            <p class="muted">Revisa y aprueba/rechaza los cambios solicitados por el Crew.</p>
            <table id="tableSolicitudesTurno">
              <thead><tr><th>Empleado</th><th>Fecha Solicitud</th><th>Semana Original</th><th>Turno original</th><th>Turno pedido</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody>
                </tbody>
            </table>
          </section>

          <section id="visualizarMalla" class="screen">
            <h2>Visualizar Malla Horaria (Turnos + Posiciones) (RR.HH. y Entrenador)</h2>
            <div class="row" style="margin-bottom: 15px;">
                <div class="col">
                    <label>Filtrar por Semana</label>
                    <select id="filtroSemanaMalla" onchange="renderMallaPublicada()"></select>
                </div>
                <div class="col-auto">
                    <div style="padding-top:20px"><p class="muted" id="mallaVisualizacionHeader"></p></div>
                </div>
            </div>
            <p class="muted" style="margin-top:-10px">Vista de la malla completa (turnos creados por Gerente y posiciones añadidas por el Gerente).</p>
            <input type="text" id="filtroMallaVisualizacion" placeholder="Buscar por Empleado, Posición o Fecha..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMallaPublicada()">
            <table id="tableMallaVisualizacion">
                <thead><tr><th>Empleado</th><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Cargo</th><th>Posición</th></tr></thead>
                <tbody>
                    </tbody>
            </table>
          </section>
          
          <section id="planificarPosiciones" class="screen">
            <h2>Planificar Posiciones del Personal Operativo (Gerente)</h2>
            <p class="muted">Asigna la posición operativa (Caja, Cocina, Automac) a cada turno en la malla publicada.</p>
            
            <div class="row" style="margin-bottom: 15px;">
                <div class="col-auto"><button class="btn btn-primary" onclick="alert('Posiciones publicadas. Entrenador puede visualizar.')">Publicar Posiciones</button></div>
            </div>

            <h3 style="margin-top: 15px;">Malla para Asignación de Posición</h3>
            <input type="text" id="filtroPlanifPosiciones" placeholder="Buscar por Empleado, Posición o Fecha..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderPlanifPosiciones()">
            <table id="tablePlanifPosiciones">
                <thead><tr><th>Empleado</th><th>Fecha</th><th>Turno</th><th>Clasificación</th><th>Posición Actual</th><th>Acciones</th></tr></thead>
                <tbody>
                    </tbody>
            </table>
          </section>

          <section id="revisarSolicitudesPosicion" class="screen">
            <h2>Solicitudes de Cambio de Posición Pendientes (Gerente)</h2>
            <p class="muted">Revisa y aprueba/rechaza los cambios de posición solicitados por los Entrenadores.</p>
            <table id="tableSolicitudesPosicion">
              <thead><tr><th>Entrenador</th><th>Fecha Solicitud</th><th>Turno</th><th>Posición Original</th><th>Posición Pedida</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
              <tbody>
                </tbody>
            </table>
          </section>
          
          
          <section id="solicitarCambioPosicionAll" class="screen">
            <h2>Solicitar Cambio de Posición (Cualquier Turno) (Entrenador)</h2>
            <p class="muted">El Entrenador puede solicitar al Gerente cambiar la posición asignada en **cualquier turno** de la malla.</p>
            <form onsubmit="event.preventDefault(); enviarSolicitudEntrenadorPosicionAll()">
                <label>Turno a Modificar</label>
                <select id="selectTodosLosTurnos" style="width: 100%;"></select>

                <label>Posición Solicitada</label>
                <input id="posicionPedidaAll" type="text" placeholder="Ej: Cocina" required>

                <label>Motivo del cambio</label>
                <textarea id="motivoCambioPosAll" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                </div>
            </form>
          </section>
          
          <section id="solicitarCambioTurno" class="screen">
            <h2>Solicitar Cambio de Turno (a Gerente)</h2>
            <p class="muted">Selecciona el turno que quieres cambiar y sugiere una alternativa para enviarla al Gerente.</p>
            
            <div id="solicitarCambioTurnoWrapper">
                <form onsubmit="event.preventDefault(); enviarSolicitud('Turno')">
                    <label>Turno Asignado a Modificar</label>
                    <select id="selectMisTurnosTurno" style="width: 100%;" onchange="prepararSolicitudCambioTurno(this.value)">
                      </select>
                    
                    <input type="hidden" id="turnoIdACambiar"> 
                    <p class="muted" style="margin-top: -10px;">Turno Original: <strong id="turnoOriginalInfo">N/A</strong></p>

                    <label>Turno Sugerido (fecha/hora)</label>
                    <input id="sugFecha" type="date" required>
                    <div class="row">
                        <div class="col"><input id="sugInicio" type="time" required></div>
                        <div class="col"><input id="sugFin" type="time" required></div>
                    </div>

                    <label>Motivo del cambio</label>
                    <textarea id="motivoCambio" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                    </div>
                </form>
            </div>
          </section>
          <section id="misTurnosYCambioEntrenador" class="screen">
              <h2>Mi Horario y Solicitud de Cambio (Entrenador)</h2>
              <div class="row" style="margin-bottom: 15px;">
                <div class="col">
                    <label>Filtrar por Semana</label>
                    <select id="filtroSemanaEntrenador" onchange="renderMiPlanillaEntrenador()"></select>
                </div>
                <div class="col-auto">
                    <div style="padding-top:20px"><p class="muted" id="miPlanillaEntrenadorHeader"></p></div>
                </div>
              </div>
              <p class="muted" style="margin-top:-10px">Tu horario personal asignado. Usa el formulario de abajo para solicitar un cambio de turno al Gerente.</p>
              
              <input type="text" id="filtroMiPlanillaEntrenador" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMiPlanillaEntrenador()">
              <table id="tableMiPlanillaEntrenador"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
              </tbody></table>

              <h3 style="margin-top: 30px;">Solicitar Cambio de Turno</h3>
              <div id="solicitarCambioTurnoEntrenadorWrapper">
                  <form onsubmit="event.preventDefault(); enviarSolicitudTurnoEntrenador()">
                      <label>Turno Asignado a Modificar</label>
                      <select id="selectMisTurnosTurnoEntrenador" style="width: 100%;" onchange="prepararSolicitudCambioTurnoEntrenador(this.value)">
                          </select>
                      
                      <input type="hidden" id="turnoIdACambiarEntrenador"> 
                      <p class="muted" style="margin-top: -10px;">Turno Original: <strong id="turnoOriginalInfoEntrenador">N/A</strong></p>

                      <label>Turno Sugerido (fecha/hora)</label>
                      <input id="sugFechaEntrenador" type="date" required>
                      <div class="row">
                          <div class="col"><input id="sugInicioEntrenador" type="time" required></div>
                          <div class="col"><input id="sugFinEntrenador" type="time" required></div>
                      </div>

                      <label>Motivo del cambio</label>
                      <textarea id="motivoCambioEntrenador" placeholder="Explica brevemente por qué solicitas el cambio" required></textarea>

                      <div style="display:flex;gap:8px;margin-top:8px;">
                          <button class="btn btn-primary" type="submit">Enviar solicitud</button>
                      </div>
                  </form>
              </div>
          </section>
          
          <section id="historialPosicion" class="screen">
            <h2>Estado de Solicitudes de Posición (Entrenador)</h2>
            <p class="muted">Revisa el estado de las solicitudes de cambio de posición que has enviado al Gerente.</p>
            <table id="tableHistorialPosicion"><thead><tr><th>Fecha solicitud</th><th>Turno</th><th>Posición Pedida</th><th>Estado</th></tr></thead><tbody>
                  </tbody></table>
          </section>

          <section id="miPlanilla" class="screen">
            <h2>Mi Horario y Posición Asignada (Crew)</h2>
            <div class="row" style="margin-bottom: 15px;">
                <div class="col">
                    <label>Filtrar por Semana</label>
                    <select id="filtroSemanaCrew" onchange="renderMiPlanilla()"></select>
                </div>
                <div class="col-auto">
                    <div style="padding-top:20px"><p class="muted" id="miPlanillaHeader"></p></div>
                </div>
            </div>
            <p class="muted" style="margin-top:-10px">Tu horario personal (turnos y posición asignada por el Gerente).</p>
            <input type="text" id="filtroMiPlanilla" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderMiPlanilla()">
            <table id="tableMiPlanilla"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
                </tbody></table>
            </section>

          <section id="estadoSolicitudes" class="screen">
            <h2>Estado de Mis Solicitudes de Cambio (Crew)</h2>
            <p class="muted">Aquí puedes ver el estado de tus solicitudes de cambio de turno (Gerente).</p>
            <table id="tableEstadoSolicitudes"><thead><tr><th>Tipo</th><th>Turno Original</th><th>Turno Pedido</th><th>Estado</th></tr></thead><tbody>
                </tbody></table>
          </section>


          <section id="historial" class="screen">
            <h2>Historial de Turnos (Personales) (Crew)</h2>
            <p class="muted">Turnos completados y registros pasados.</p>
            <input type="text" id="filtroHistorial" placeholder="Buscar por fecha (YYYY-MM-DD)..." style="width: 100%; margin-bottom: 10px;" onkeyup="renderHistorial()">
            <table id="tableHistorial"><thead><tr><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Clasificación</th><th>Posición</th></tr></thead><tbody>
                </tbody></table>
          </section>
          
        </main>
      </div>
    </div>
  </div>

  <script>
    /* ======================================
      Variables en memoria (simulan DB temporal)
      ====================================== */

    let currentUser = null; // {name, role}
    let allUsers = [
        { name: 'Admin User', role: 'admin', user: 'admin', pass: '1234' },
        { name: 'Ricardo RRHH', role: 'rrhh', user: 'rrhh', pass: '1234' },
        { name: 'Gerente Jefe', role: 'gerente', user: 'gerente', pass: '1234' },
        { name: 'Entrenador Juan', role: 'entrenador', user: 'entrenador', pass: '1234' },
        { name: 'Entrenador Sofi', role: 'entrenador', user: 'sofi', pass: '1234' }, 
        { name: 'Entrenador Luis', role: 'entrenador', user: 'luis', pass: '1234' }, 
        { name: 'Crew Constanza', role: 'crew', user: 'crew', pass: '1234' },
        { name: 'Crew Felipe', role: 'crew', user: 'felipe', pass: '1234' },
        { name: 'Crew Andrea', role: 'crew', user: 'andrea', pass: '1234' }, 
        { name: 'Crew Daniel', role: 'crew', user: 'daniel', pass: '1234' }, 
        { name: 'Crew Emilia', role: 'crew', user: 'emilia', pass: '1234' }, 
        { name: 'Crew Gaston', role: 'crew', user: 'gaston', pass: '1234' }, 
        { name: 'Crew Jose', role: 'crew', user: 'jose', pass: '1234' }, 
    ];

    let planillaPublicada = []; // Malla con Turnos + Posiciones

    // NEW: Malla Metadata for visualization
    let mallaMetadata = {
        startDate: '2025-10-27', // Lunes 27 de Octubre
        endDate: '2025-11-23', // Domingo 23 de Noviembre (4 semanas)
        publicationDate: new Date('2025-10-24T10:00:00').toLocaleString(), // Viernes 24 de Octubre (Publicado 3 días antes)
        publicationDateISO: new Date('2025-10-24T10:00:00').toISOString() // Para comparación fiable
    };
    
    let solicitudes = []; // Todas las solicitudes (Turno, PosicionEntrenador, PosicionCrew)


    const ROLES = {
        admin: 'Admin',
        rrhh: 'RR.HH.',
        gerente: 'Gerente',
        entrenador: 'Entrenador',
        crew: 'Crew'
    };

    const POSICIONES_BASE = ['Caja', 'Cocina', 'Automac', 'Sala', 'Lobby'];
    
    // Función de utilidad para alternar formularios
    function toggleForm(id){
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    // NEW UTILITY: Calculates the start and end date of the week for a given date.
    function getWeekInfoByDate(dateString) {
        const date = new Date(dateString + 'T00:00:00'); // Use midnight UTC to avoid timezone issues
        const dayOfWeek = (date.getDay() + 6) % 7; // Adjust Sunday (0) to be last (6), Monday (1) to be first (0)
        
        // Start date (Monday)
        const start = new Date(date);
        start.setDate(date.getDate() - dayOfWeek);

        // End date (Sunday)
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        
        const formatDate = (d) => {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        return {
            start: formatDate(start),
            end: formatDate(end),
            display: `${formatDate(start)} al ${formatDate(end)}`
        };
    }
    
    // NEW UTILITY: Generates a list of all distinct weeks within the mallaMetadata range.
    function getAllWeeksInMalla() {
        const start = new Date(mallaMetadata.startDate + 'T00:00:00');
        const end = new Date(mallaMetadata.endDate + 'T00:00:00');
        const weeks = [];
        
        let current = new Date(start);
        // Advance current date to the start of its week (Monday)
        current.setDate(current.getDate() - (current.getDay() + 6) % 7);
        
        let i = 1;
        while (current <= end) {
            const weekInfo = getWeekInfoByDate(current.toISOString().split('T')[0]);
            
            // Avoid adding weeks that start before the global malla start date, 
            // unless the malla start date is a Monday (already handled by date setting)
            if (weeks.length === 0 || weeks[weeks.length - 1].start !== weekInfo.start) {
                weeks.push({
                    id: `week${i++}`,
                    ...weekInfo
                });
            }
            // Move to the next Monday (start of the next week)
            current.setDate(current.getDate() + 7);
        }
        return weeks;
    }


    /* ---------- FUNCIONES HOME/DASHBOARD ---------- */
    function updateHomeDashboard() {
        if (!currentUser) return;
        
        // Solo Gerente usa el home
        if (currentUser.role !== 'gerente') return;

        // FIX 1: Contar solo turnos de personal operativo (Crew o Entrenador) para la congruencia.
        const operationalShifts = planillaPublicada.filter(t => t.cargo !== 'Gerente' && t.cargo !== 'Admin' && t.cargo !== 'RR.HH.' && t.inicio !== 'Libre');
        
        // 1. Planilla Info 
        document.getElementById('homePlanillaInfo').innerText = operationalShifts.length + ' turnos operativos publicados'; 
        
        // 2. Solicitudes Pendientes
        // Gerente revisa Solicitudes de Turno ('Turno') y Solicitudes de Posición (Entr.) ('PosicionEntrenador')
        let pendingCount = solicitudes.filter(s => s.estado === 'Pendiente' && (s.tipo === 'Turno' || s.tipo === 'PosicionEntrenador')).length;
        
        document.getElementById('homeSolicitudesInfo').innerText = pendingCount;
    }


    // Navegación simple entre "pantallas" (secciones) del mockup
    function nav(screenId){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      const screen = document.getElementById(screenId);
      if(screen) screen.classList.add('active');

      // Mostrar/ocultar menús según rol
      document.getElementById('menuAdmin').style.display = (currentUser && currentUser.role==='admin') ? 'block' : 'none';
      document.getElementById('menuRRHH').style.display = (currentUser && currentUser.role==='rrhh') ? 'block' : 'none';
      document.getElementById('menuGerente').style.display = (currentUser && currentUser.role==='gerente') ? 'block' : 'none';
      document.getElementById('menuEntrenador').style.display = (currentUser && currentUser.role==='entrenador') ? 'block' : 'none';
      document.getElementById('menuCrew').style.display = (currentUser && currentUser.role==='crew') ? 'block' : 'none';

      document.getElementById('btnLogin').style.display = currentUser ? 'none' : 'inline-block';
      document.getElementById('btnLogout').style.display = currentUser ? 'inline-block' : 'none';

      document.getElementById('headerRole').innerText = currentUser ? `Rol: ${ROLES[currentUser.role]}` : 'Rol: Invitado';

      // Ajuste de diseño: Si está logueado, ajusta el app para que no centre verticalmente
      document.querySelector('.app').classList.toggle('logged-in', !!currentUser);
      
      // Mostrar Home button solo para Gerente (Roles que lo utilizan)
      const showHome = currentUser && (currentUser.role === 'gerente'); 
      document.getElementById('homeButton').style.display = showHome ? 'block' : 'none';

      // Acciones por pantalla que requieren renderizado
      if(screenId==='home') updateHomeDashboard();
      if(screenId==='gestionUsuarios') renderTablaUsuarios();
      if(screenId==='planificarRRHH') renderMallaRRHH(); // Función modificada
      
      if(screenId==='miPlanilla') {
        populateWeekFilters(); // NEW
        renderMiPlanilla();
      }
      
      // NEW KPI RENDER
      if(screenId==='kpisRRHH') renderKpisRRHH();
      
      if(screenId==='visualizarMalla') { // NEW
          populateWeekFilters(); 
          renderMallaPublicada();
      }
      
      if(screenId==='planificarPosiciones') renderPlanifPosiciones();
      if(screenId==='revisarSolicitudesTurno') renderSolicitudes('Turno');
      if(screenId==='revisarSolicitudesPosicion') renderSolicitudes('PosicionEntrenador'); // Gerente revisa Entrenador
      if(screenId==='historial') renderHistorial();
      if(screenId==='estadoSolicitudes') renderEstadoSolicitudes();
      if(screenId==='solicitarCambioPosicionAll') populateTurnosAllSelect(); // Entrenador
      if(screenId==='solicitarCambioTurno') populateMisTurnosTurnoSelect(); // Crew: new screen
      
      // NEW SECTION FOR TRAINER
      if(screenId==='misTurnosYCambioEntrenador') {
        populateWeekFilters(); // NEW
        renderMiPlanillaEntrenador();
        populateMisTurnosTurnoSelectEntrenador(); 
      }
      
      if(screenId==='historialPosicion') renderHistorialPosicion(); // Entrenador
    }

    // Simula login (sin seguridad) - actualiza UI y menus
    function doLogin(){
      const user = document.getElementById('loginUsuario').value.trim().toLowerCase();
      const pass = document.getElementById('loginPass').value.trim();
      const rol = document.getElementById('loginRol').value;
      
      const foundUser = allUsers.find(u => u.user === user && u.pass === pass && u.role === rol);

      if(!foundUser) {
          alert('Credenciales incorrectas o Rol no coincide. Pruebe "admin", "rrhh", "gerente", "entrenador", "crew" con contraseña "1234".');
          return;
      }
      
      currentUser = foundUser;
      document.getElementById('userName').innerText = foundUser.name + ' (' + ROLES[foundUser.role] + ')';
      
      // Redirección inicial según el rol (Requisito del usuario)
      let initialScreen = 'home';
      if (foundUser.role === 'admin') initialScreen = 'gestionUsuarios';
      else if (foundUser.role === 'rrhh') initialScreen = 'visualizarMalla'; // RRHH directo a Malla (Home eliminado)
      else if (foundUser.role === 'entrenador') initialScreen = 'visualizarMalla'; // Entrenador directo a Malla (Home eliminado)
      else if (foundUser.role === 'crew') initialScreen = 'miPlanilla'; // Crew directo a Planilla (Home eliminado)

      nav(initialScreen);
    }

    function logout(){
      if(!confirm('Cerrar sesión?')) return;
      currentUser = null;
      document.getElementById('userName').innerText = '(no has iniciado sesión)';
      document.getElementById('headerRole').innerText = 'Rol: Invitado';
      nav('login');
    }

    /* ---------- FUNCIONES ADMIN (Gestion de Usuarios) ---------- */
    function renderTablaUsuarios() {
        const tbody = document.querySelector('#tableUsuarios tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroUsuarios').value.toLowerCase();
        
        allUsers.filter(u => 
            u.name.toLowerCase().includes(filtro) || 
            ROLES[u.role].toLowerCase().includes(filtro)
        ).forEach((u) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.name}</td><td>${ROLES[u.role]}</td><td>${u.user}</td><td>-</td><td class="actions">
                <button class='btn btn-sec' onclick='toggleForm("formCrearUsuario")'>Editar</button>
                <button class='btn btn-primary' onclick='eliminarUsuario("${u.user}")'>Eliminar</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }

    // NEW FUNCTION: Guarda un nuevo usuario en la lista
    function guardarUsuarioAdmin() {
        const name = document.getElementById('adminNewName').value.trim();
        const user = document.getElementById('adminNewUser').value.trim();
        const pass = document.getElementById('adminNewPass').value.trim();
        const role = document.getElementById('adminNewRole').value;

        if (!name || !user || !pass || !role) {
            return alert('Todos los campos son obligatorios para crear un usuario.');
        }

        if (allUsers.some(u => u.user === user)) {
            return alert('El usuario (login) ya existe. Intente con otro.');
        }

        const newUser = {
            name: name,
            role: role,
            user: user,
            pass: pass
        };

        allUsers.push(newUser);
        alert(`Usuario "${name}" (${ROLES[role]}) creado con éxito.`);
        
        // Reset form and re-render table
        document.getElementById('adminUserForm').reset();
        toggleForm('formCrearUsuario');
        renderTablaUsuarios();
    }

    function eliminarUsuario(user) {
        if (confirm(`¿Eliminar usuario ${user}? (Simulado)`)) {
            allUsers = allUsers.filter(u => u.user !== user);
            renderTablaUsuarios();
        }
    }

    /* ---------- FUNCIONES RRHH (KPIs) ---------- */

    function getKpiStatus(result, expected, isBetterHigher) {
        if (result === null || isNaN(result)) return { status: 'Deficiente', className: 'deficient' };
        
        if (isBetterHigher) { // Mejor si es MAYOR
            if (result > expected) return { status: 'Mejor de lo esperado', className: 'better' };
            if (result === expected) return { status: 'Esperado', className: 'expected' };
            return { status: 'Deficiente', className: 'deficient' };
        } else { // Mejor si es MENOR (o igual al objetivo)
            if (result < expected) return { status: 'Mejor de lo esperado', className: 'better' };
            if (result === expected) return { status: 'Esperado', className: 'expected' };
            return { status: 'Deficiente', className: 'deficient' };
        }
    }
    
    // NEW UTILITY: Renders a KPI card including raw data table
    function renderKpiCard(title, result, expected, isBetterHigher, rawData, unit = '%', denominatorDescription = '') {
        const status = getKpiStatus(result, expected, isBetterHigher);
        
        let tableHtml = '';
        if (rawData) {
            tableHtml = `<table class="kpi-detail-table">`;
            for (const key in rawData) {
                tableHtml += `<tr><td><strong>${key}:</strong></td><td style="text-align:right">${rawData[key]}</td></tr>`;
            }
            tableHtml += `</table>`;
        }
        
        return `
            <div class="kpi-card">
                <h4>${title}</h4>
                <p class="muted">Objetivo: ${expected}${unit}</p>
                <div class="kpi-value">${result.toFixed(2)}${unit}</div>
                <div class="kpi-status ${status.className}">
                    ${status.status}
                </div>
                ${tableHtml}
            </div>
        `;
    }

    
    function renderKpisRRHH() {
        // --- Setup and Data Filtering ---
        const totalOperativos = allUsers.filter(u => u.role === 'crew' || u.role === 'entrenador').length; // Total: 10
        const totalDias = 28; 
        const pubDateISO = mallaMetadata.publicationDateISO; 
        const timeframe = document.getElementById('kpiTimeframe')?.value || 'month';

        const turnosOperativosReales = planillaPublicada.filter(t => 
            (t.cargo === 'Crew' || t.cargo === 'Entrenador') && t.inicio !== 'Libre'
        );
        const totalTurnosPlanificados = turnosOperativosReales.length; // Total: 80
        
        const totalSolicitudesRelevantes = solicitudes.filter(s => s.tipo === 'Turno' || s.tipo === 'PosicionEntrenador'); // Total: 15

        // --- CALCULATION HELPERS BASED ON TIMEFRAME ---
        let periodDivisor = 1;
        let denominatorLabel = "total";
        
        if (timeframe === 'week') {
            periodDivisor = 4;
            denominatorLabel = "promedio semanal";
        } else if (timeframe === 'day') {
            periodDivisor = totalDias; 
            denominatorLabel = "promedio diario";
        }
        
        // --- KPI 1: Tasa de carga personal (Fixed to Daily Average) ---
        const turnosPorClasificacion = turnosOperativosReales.reduce((acc, t) => {
            acc[t.clasificacion] = (acc[t.clasificacion] || 0) + 1;
            return acc;
        }, {});
        
        const kpi1 = [];
        const expectedKpi1 = 8;
        
        ['am', 'pm', 'nocturno'].forEach(c => {
            const countMensual = turnosPorClasificacion[c] || 0;
            const countPromedioDiario = countMensual / totalDias; 
            
            const tasa = totalOperativos > 0 ? (countPromedioDiario / totalOperativos) * 100 : 0;
            
            kpi1.push(renderKpiCard(
                `Tasa de Carga: ${c.toUpperCase()}`,
                tasa,
                expectedKpi1,
                true,
                {
                    'Turnos Mensuales': countMensual.toFixed(0),
                    'Empleados Operativos': totalOperativos,
                    'Turnos Prom. Diario': countPromedioDiario.toFixed(2)
                }
            ));
        });
        
        document.getElementById('kpi1Container').innerHTML = kpi1.join('');


        // --- KPI 2: Porcentaje modificaciones a turnos despues del plan semanal ---
        const solicitudesTurnoAprobadas = solicitudes.filter(s => s.tipo === 'Turno' && s.estado === 'Aprobado');
        
        const modificacionesPostPlanAprobadas = solicitudesTurnoAprobadas.filter(s => {
            const fechaRespuesta = new Date(s.fechaRespuesta);
            const pubDate = new Date(pubDateISO);
            return fechaRespuesta > pubDate;
        }).length; // Expected: 8
        
        const totalPlanificadosBase = totalTurnosPlanificados / periodDivisor;
        const modificacionCountBase = modificacionesPostPlanAprobadas / periodDivisor; 
        
        const porcentajeModificaciones = totalPlanificadosBase > 0 ? 
                                         (modificacionCountBase / totalPlanificadosBase) * 100 : 0; // Expected: 10.00%
        const expectedKpi2 = 10;
        // MODIFICACIÓN 1: isBetterHigher = false, ya que es mejor si el porcentaje es menor o igual al 10%
        const statusKpi2 = getKpiStatus(porcentajeModificaciones, expectedKpi2, false); 
        
        const kpi2Card = renderKpiCard(
            `% Modificaciones Post-Plan`,
            porcentajeModificaciones,
            expectedKpi2,
            false, // MODIFICADO: Mejor si es MENOR
            {
                'Solicitudes Aprobadas Post-Plan': modificacionesPostPlanAprobadas.toFixed(0),
                'Turnos Planificados (Base)': totalTurnosPlanificados.toFixed(0),
                'Base de Cálculo': totalPlanificadosBase.toFixed(2) + ' ' + denominatorLabel
            }
        );
        
        // --- KPI 3: Tasa de revisión oportuna de solicitudes ---
        const revisadasDentroPlazo = totalSolicitudesRelevantes.filter(s => 
            s.estado !== 'Pendiente' && 
            checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta) === 'dentro del plazo'
        ).length; // Expected: 12
        
        const totalSolicitudesBase = totalSolicitudesRelevantes.length / periodDivisor;
        const revisadasBase = revisadasDentroPlazo / periodDivisor;

        const tasaRevision = totalSolicitudesBase > 0 ? 
                             (revisadasBase / totalSolicitudesBase) * 100 : 0; // Expected: 80.00%
        const expectedKpi3 = 95;
        const statusKpi3 = getKpiStatus(tasaRevision, expectedKpi3, true);

        const kpi3Card = renderKpiCard(
            'Tasa de Revisión Oportuna (Solicitudes)',
            tasaRevision,
            expectedKpi3,
            true,
            {
                'Solicitudes Resueltas a Tiempo': revisadasDentroPlazo.toFixed(0),
                'Total Solicitudes Relevantes': totalSolicitudesRelevantes.length.toFixed(0),
                'Base de Cálculo': totalSolicitudesBase.toFixed(2) + ' ' + denominatorLabel
            }
        );

        document.getElementById('kpi2kpi3Container').innerHTML = kpi2Card + kpi3Card;
    }

    /* ---------- FUNCIONES GERENTE (Creación de Malla) ---------- */
    
    // Función para obtener las fechas de la semana seleccionada
    function getDatesOfWeek(startDateString) {
      const dates = [];
      const currentDate = new Date(startDateString);
      // Asegurar que la fecha sea la correcta ajustando la zona horaria
      currentDate.setHours(currentDate.getHours() + currentDate.getTimezoneOffset() / 60);

      for (let i = 0; i < 7; i++) {
          const date = new Date(currentDate);
          date.setDate(currentDate.getDate() + i);
          
          const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
          const day = date.getDay(); // 0 (Domingo) a 6 (Sábado)

          // Formato YYYY-MM-DD
          const yyyy = date.getFullYear();
          const mm = String(date.getMonth() + 1).padStart(2, '0');
          const dd = String(date.getDate()).padStart(2, '0');
          const dateString = `${yyyy}-${mm}-${dd}`;
          
          dates.push({
              date: dateString,
              dayName: dayNames[day],
              display: `${dayNames[day]} ${dd}/${mm}`
          });
      }
      return dates;
    }

    // Inicializa los selects del formulario de Gerente (Turnos)
    function setupRRHHForm(weekDates) {
        const selectEmpleado = document.getElementById('rrhhEmpleadoTurno');
        const selectDia = document.getElementById('rrhhDiaTurno');
        
        // Empleados (solo Crew y Entrenador pueden tener turnos operativos)
        selectEmpleado.innerHTML = allUsers
            .filter(u => u.role === 'crew' || u.role === 'entrenador')
            .map(u => `<option value="${u.name}|${u.role}">${u.name} (${ROLES[u.role]})</option>`)
            .join('');

        // Días de la semana
        selectDia.innerHTML = weekDates
            .map(d => `<option value="${d.date}">${d.display}</option>`)
            .join('');
    }
    
    // Renderiza la tabla de malla para Gerente (Turnos)
    function renderMallaRRHH() {
        const inicioSemana = document.getElementById('rrhhSemanaInicio').value;
        const weekDates = getDatesOfWeek(inicioSemana);
        document.getElementById('rrhhSemanaFin').value = weekDates[6].date; // Actualiza Fin de Semana
        
        setupRRHHForm(weekDates);

        const container = document.getElementById('rrhhMallaContainer');
        
        // 1. Crear el encabezado de la tabla
        let tableHTML = `<table style="font-size: 13px;"><thead><tr><th>Empleado</th>`;
        weekDates.forEach(d => {
            tableHTML += `<th>${d.display}</th>`;
        });
        tableHTML += `</tr></thead><tbody>`;

        // 2. Agrupar turnos por empleado
        const turnosPorEmpleado = planillaPublicada.reduce((acc, t) => {
            if (!acc[t.empleado]) acc[t.empleado] = {};
            acc[t.empleado][t.fecha] = t;
            return acc;
        }, {});
        
        // 3. Obtener solo empleados con turnos operativos (Crew y Entrenador)
        const empleadosOperativos = allUsers.filter(u => u.role === 'crew' || u.role === 'entrenador');

        // 4. Llenar la tabla
        empleadosOperativos.forEach(u => {
            tableHTML += `<tr><td>${u.name} (${ROLES[u.role]})</td>`;
            weekDates.forEach(d => {
                const turno = turnosPorEmpleado[u.name] ? turnosPorEmpleado[u.name][d.date] : null;
                if (turno) {
                    const turnoId = `${turno.id}`;
                    const isLibre = turno.inicio === 'Libre';
                    const clasificacion = turno.clasificacion ? ` (${turno.clasificacion.toUpperCase()})` : '';
                    tableHTML += `<td><div class="turno-box ${isLibre ? 'turno-libre' : ''}" onclick="abrirFormEditarTurno('${turnoId}')">
                                      ${isLibre ? 'DÍA LIBRE' : `${turno.inicio} - ${turno.fin}${clasificacion}`}
                                  </div></td>`;
                } else {
                    // Botón para crear nuevo turno
                    tableHTML += `<td><button class='btn' style='padding:5px; font-size:11px;' onclick="abrirFormCrearTurno('${u.name}|${u.role}', '${d.date}')">Asignar</button></td>`;
                }
            });
            tableHTML += `</tr>`;
        });
        
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    // Abre el formulario para crear un nuevo turno (pre-rellena empleado y día)
    function abrirFormCrearTurno(empleadoValor, diaFecha) {
        document.getElementById('rrhhTurnoId').value = '';
        document.getElementById('rrhhEmpleadoTurno').value = empleadoValor;
        document.getElementById('rrhhDiaTurno').value = diaFecha;
        document.getElementById('rrhhHoraInicio').value = '';
        document.getElementById('rrhhHoraFin').value = '';
        document.getElementById('rrhhTipoTurno').value = 'Normal'; // Set default
        document.getElementById('rrhhClasificacionTurno').value = 'am'; // Set default
        document.getElementById('turnos-row').style.display = 'flex'; // Show times
        document.querySelector('#formAgregarTurnoRRHH h3').innerText = 'Agregar Turno';
        toggleForm('formAgregarTurnoRRHH');
    }

    // Abre el formulario para editar un turno existente
    function abrirFormEditarTurno(turnoId) {
        const turno = planillaPublicada.find(t => t.id == turnoId);
        if (!turno) return alert('Turno no encontrado.');

        document.getElementById('rrhhTurnoId').value = turnoId;
        document.getElementById('rrhhEmpleadoTurno').value = `${turno.empleado}|${turno.cargo.toLowerCase()}`;
        document.getElementById('rrhhDiaTurno').value = turno.fecha;
        
        // Si el turno es "DÍA LIBRE"
        if(turno.inicio === 'Libre'){
            document.getElementById('rrhhTipoTurno').value = 'Libre';
            document.getElementById('turnos-row').style.display = 'none';
            document.getElementById('rrhhHoraInicio').value = '';
            document.getElementById('rrhhHoraFin').value = '';
            document.getElementById('rrhhClasificacionTurno').value = 'am';
        } else {
            document.getElementById('rrhhTipoTurno').value = 'Normal';
            document.getElementById('turnos-row').style.display = 'flex';
            document.getElementById('rrhhHoraInicio').value = turno.inicio;
            document.getElementById('rrhhHoraFin').value = turno.fin;
            document.getElementById('rrhhClasificacionTurno').value = turno.clasificacion || 'am'; // Load classification
        }
        
        document.querySelector('#formAgregarTurnoRRHH h3').innerText = 'Editar Turno';
        toggleForm('formAgregarTurnoRRHH');
    }

    // Guarda o actualiza un turno en la planilla (Gerente)
    function guardarTurnoRRHH() {
        const id = document.getElementById('rrhhTurnoId').value;
        const [empleado, cargo] = document.getElementById('rrhhEmpleadoTurno').value.split('|');
        const fecha = document.getElementById('rrhhDiaTurno').value;
        const tipoTurno = document.getElementById('rrhhTipoTurno').value;
        const clasificacionTurno = document.getElementById('rrhhClasificacionTurno').value;

        let inicio = document.getElementById('rrhhHoraInicio').value;
        let fin = document.getElementById('rrhhHoraFin').value;
        
        // Encontrar el índice del turno a editar/eliminar (si existe)
        const existingIndex = planillaPublicada.findIndex(t => t.id == id);
        
        // Lógica para "Día Libre"
        if (tipoTurno === 'Libre') {
            // Eliminar la entrada existente para ese día/empleado si ya existía
            if (existingIndex !== -1) {
                planillaPublicada.splice(existingIndex, 1);
            }
            alert('Día marcado como Libre/No Asignado (Simulado)');
            toggleForm('formAgregarTurnoRRHH');
            renderMallaRRHH();
            updateHomeDashboard();
            return;
        }

        if (!inicio || !fin) return alert('Debes ingresar la hora de inicio y fin para un turno normal.');

        if (id) {
            if (existingIndex !== -1) {
                planillaPublicada[existingIndex].fecha = fecha;
                planillaPublicada[existingIndex].inicio = inicio;
                planillaPublicada[existingIndex].fin = fin;
                planillaPublicada[existingIndex].empleado = empleado;
                planillaPublicada[existingIndex].cargo = ROLES[cargo];
                planillaPublicada[existingIndex].clasificacion = clasificacionTurno;
                alert('Turno actualizado con éxito (simulado)');
            }
        } else {
            const nuevoTurno = {
                id: Date.now(),
                empleado,
                fecha,
                inicio,
                fin,
                cargo: ROLES[cargo],
                posicion: null,
                clasificacion: clasificacionTurno
            };
            planillaPublicada.push(nuevoTurno);
            alert('Nuevo turno agregado con éxito (simulado)');
        }
        
        toggleForm('formAgregarTurnoRRHH');
        renderMallaRRHH();
        updateHomeDashboard();
    }


    /* ---------- FUNCIONES MALLA / PLANILLA (Compartidas) ---------- */
    
    // Carga demo de planilla para que Gerente y Crew tengan datos
    function seedDemo(){
        const now = new Date();
        const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
        const fiveDaysAgo = new Date(now); fiveDaysAgo.setDate(now.getDate() - 5);
        const tenDaysAgo = new Date(now); tenDaysAgo.setDate(now.getDate() - 10);
        const fifteenDaysAgo = new Date(now); fifteenDaysAgo.setDate(now.getDate() - 15);
        const twentyDaysAgo = new Date(now); twentyDaysAgo.setDate(now.getDate() - 20);
        
        // Set Publication Date to 25 days ago (to test KPI 2 logic against a past "Plan Semanal")
        const pubDate = new Date(now); pubDate.setDate(now.getDate() - 25);
        mallaMetadata.publicationDate = pubDate.toLocaleString(); 
        mallaMetadata.publicationDateISO = pubDate.toISOString(); // Store ISO for comparison
        
        // Reference Dates for Solicitudes (Deadline is 7 days from request date)
        const todayISO = now.toISOString();
        const fiveDaysAgoISO = fiveDaysAgo.toISOString();
        const tenDaysAgoISO = tenDaysAgo.toISOString();
        const fifteenDaysAgoISO = fifteenDaysAgo.toISOString();
        const twentyDaysAgoISO = twentyDaysAgo.toISOString();
        const pubDateISO = pubDate.toISOString();


        // --- USERS (13 total. 10 operativos: 3 Entrenadores, 7 Crew) ---
        allUsers = [
            { name: 'Admin User', role: 'admin', user: 'admin', pass: '1234' },
            { name: 'Ricardo RRHH', role: 'rrhh', user: 'rrhh', pass: '1234' },
            { name: 'Gerente Jefe', role: 'gerente', user: 'gerente', pass: '1234' },
            { name: 'Entrenador Juan', role: 'entrenador', user: 'entrenador', pass: '1234' },
            { name: 'Entrenador Sofi', role: 'entrenador', user: 'sofi', pass: '1234' }, 
            { name: 'Entrenador Luis', role: 'entrenador', user: 'luis', pass: '1234' }, 
            { name: 'Crew Constanza', role: 'crew', user: 'crew', pass: '1234' },
            { name: 'Crew Felipe', role: 'crew', user: 'felipe', pass: '1234' },
            { name: 'Crew Andrea', role: 'crew', user: 'andrea', pass: '1234' }, 
            { name: 'Crew Daniel', role: 'crew', user: 'daniel', pass: '1234' }, 
            { name: 'Crew Emilia', role: 'crew', user: 'emilia', pass: '1234' }, 
            { name: 'Crew Gaston', role: 'crew', user: 'gaston', pass: '1234' }, 
            { name: 'Crew Jose', role: 'crew', user: 'jose', pass: '1234' }, 
        ];

        // --- PLANILLA (80 turnos operativos + 4 de Gerente = 84 total.) ---
        // Generando 8 turnos por empleado operativo (10 empleados) * 4 semanas = 80 turnos
        planillaPublicada = [];
        const operationalNames = allUsers.filter(u => u.role === 'crew' || u.role === 'entrenador').map(u => u.name);
        let idCounter = 100;
        
        for (let w = 0; w < 4; w++) {
            for (let d = 0; d < 7; d++) {
                const date = new Date(mallaMetadata.startDate);
                date.setDate(date.getDate() + (w * 7) + d);
                const dateString = date.toISOString().split('T')[0];
                
                // Distribución de 3 turnos por día para 10 empleados (casi 3 empleados por turno)
                const assignments = [
                    { name: 'Crew Constanza', time: '07:00-15:00', pos: 'Caja', clas: 'am' },
                    { name: 'Crew Felipe', time: '08:00-16:00', pos: 'Cocina', clas: 'am' },
                    { name: 'Crew Andrea', time: '09:00-17:00', pos: 'Sala', clas: 'am' },
                    { name: 'Entrenador Juan', time: '13:00-21:00', pos: 'Cocina', clas: 'pm' },
                    { name: 'Entrenador Sofi', time: '14:00-22:00', pos: 'AutoMac', clas: 'pm' },
                    { name: 'Crew Daniel', time: '15:00-23:00', pos: 'Caja', clas: 'pm' },
                    { name: 'Crew Emilia', time: '22:00-06:00', pos: 'Cocina', clas: 'nocturno' },
                    { name: 'Entrenador Luis', time: '23:00-07:00', pos: 'AutoMac', clas: 'nocturno' },
                    // Relleno aleatorio para llegar a 80
                    { name: 'Crew Gaston', time: '10:00-18:00', pos: 'Sala', clas: 'am' },
                    { name: 'Crew Jose', time: '11:00-19:00', pos: 'Caja', clas: 'pm' },
                ];
                
                assignments.forEach(a => {
                    if (idCounter < 181) { // Stop at 80 operational shifts
                        planillaPublicada.push({ 
                            id: ++idCounter, 
                            empleado: a.name, 
                            fecha: dateString, 
                            inicio: a.time.split('-')[0], 
                            fin: a.time.split('-')[1], 
                            cargo: allUsers.find(u => u.name === a.name).role.replace('entrenador', 'Entrenador').replace('crew', 'Crew'), 
                            posicion: a.pos, 
                            clasificacion: a.clas
                        });
                    }
                });
            }
        }
        
        // Agregar 4 turnos de Gerente
        planillaPublicada.push(
            { id: 201, empleado:'Gerente Jefe', fecha:'2025-10-27', inicio:'07:00', fin:'15:00', cargo:'Gerente', posicion:'Oficina', clasificacion: 'am'},
            { id: 202, empleado:'Gerente Jefe', fecha:'2025-11-03', inicio:'07:00', fin:'15:00', cargo:'Gerente', posicion:'Oficina', clasificacion: 'am'},
            { id: 203, empleado:'Gerente Jefe', fecha:'2025-11-10', inicio:'07:00', fin:'15:00', cargo:'Gerente', posicion:'Oficina', clasificacion: 'am'},
            { id: 204, empleado:'Gerente Jefe', fecha:'2025-11-17', inicio:'07:00', fin:'15:00', cargo:'Gerente', posicion:'Oficina', clasificacion: 'am'},
        );


        // --- SOLICITUDES (Total 15 relevantes para KPI 3) ---
        solicitudes = [
            // S1 (Turno): PENDIENTE (Enviada hoy) (KPI 3)
            { id: 1, tipo: 'Turno', empleado: 'Crew Constanza', turnoOriginalId: 101, turnoOriginal: '2025-10-27 07:00-15:00', turnoPedido: '2025-10-27 09:00-17:00', motivo: 'Cambio de bus', estado: 'Pendiente', fechaSolicitud: todayISO, motivoRechazo: null, fechaRespuesta: null, semanaOriginal: getWeekInfoByDate('2025-10-27').display },

            // --- RESUELTAS DENTRO DE PLAZO (12 total para KPI 3) ---
            // S2 (Turno): Aprobado - Resuelto 5 días después. (KPI 2 & 3)
            { id: 2, tipo: 'Turno', empleado: 'Crew Felipe', turnoOriginalId: 104, turnoOriginal: '2025-10-28 10:00-18:00', turnoPedido: '2025-10-28 11:00-19:00', motivo: 'Cita médica', estado: 'Aprobado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: null, fechaRespuesta: tenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-28').display },
            // S3 (PosEntr): Rechazado - Resuelto 2 días después. (KPI 3)
            { id: 3, tipo: 'PosicionEntrenador', empleado: 'Entrenador Juan', turnoOriginalId: 114, turnoOriginal: '2025-10-28 09:00-17:00', posicionOriginal: 'Sala', posicionPedida: 'Caja', motivo: 'Necesito más experiencia', estado: 'Rechazado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: 'No hay reemplazo en Sala.', fechaRespuesta: tenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-28').display },
            // S4 (Turno): Aprobado - Resuelto 1 día después. (KPI 2 & 3)
            { id: 4, tipo: 'Turno', empleado: 'Crew Andrea', turnoOriginalId: 107, turnoOriginal: '2025-10-28 16:00-23:00', turnoPedido: '2025-10-28 14:00-21:00', motivo: 'Cambio de estudios', estado: 'Aprobado', fechaSolicitud: twentyDaysAgoISO, motivoRechazo: null, fechaRespuesta: fifteenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-28').display },
            // S5 (PosEntr): Aprobado - Resuelto 3 días después. (KPI 3)
            { id: 5, tipo: 'PosicionEntrenador', empleado: 'Entrenador Sofi', turnoOriginalId: 116, turnoOriginal: '2025-10-29 14:00-22:00', posicionOriginal: 'Cocina', posicionPedida: 'Caja', motivo: 'Mejor visibilidad', estado: 'Aprobado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: null, fechaRespuesta: tenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-29').display },
            // S6 (Turno): Aprobado - Resuelto 5 días después. (KPI 2 & 3)
            { id: 6, tipo: 'Turno', empleado: 'Crew Daniel', turnoOriginalId: 109, turnoOriginal: '2025-10-30 08:00-15:00', turnoPedido: '2025-10-30 10:00-17:00', motivo: 'Problema familiar', estado: 'Aprobado', fechaSolicitud: fiveDaysAgoISO, motivoRechazo: null, fechaRespuesta: todayISO, semanaOriginal: getWeekInfoByDate('2025-10-30').display },
            // S7 (PosEntr): Rechazado - Resuelto 1 día después. (KPI 3)
            { id: 7, tipo: 'PosicionEntrenador', empleado: 'Entrenador Luis', turnoOriginalId: 118, turnoOriginal: '2025-11-01 07:00-15:00', posicionOriginal: 'Sala', posicionPedida: 'Cocina', motivo: 'Entrenamiento en Cocina', estado: 'Rechazado', fechaSolicitud: fiveDaysAgoISO, motivoRechazo: 'Posición no prioritaria.', fechaRespuesta: todayISO, semanaOriginal: getWeekInfoByDate('2025-11-01').display },
            // S8 (Turno): Aprobado - Resuelto 2 días después. (KPI 2 & 3)
            { id: 8, tipo: 'Turno', empleado: 'Crew Emilia', turnoOriginalId: 111, turnoOriginal: '2025-11-01 09:00-17:00', turnoPedido: '2025-11-01 10:00-18:00', motivo: 'Cambio solicitado por Gerente', estado: 'Aprobado', fechaSolicitud: tenDaysAgoISO, motivoRechazo: null, fechaRespuesta: fiveDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-11-01').display },
            // S9 (PosEntr): Aprobado - Resuelto 3 días después. (KPI 3)
            { id: 9, tipo: 'PosicionEntrenador', empleado: 'Entrenador Juan', turnoOriginalId: 115, turnoOriginal: '2025-10-30 10:00-18:00', posicionOriginal: 'AutoMac', posicionPedida: 'Cocina', motivo: 'Necesario', estado: 'Aprobado', fechaSolicitud: fiveDaysAgoISO, motivoRechazo: null, fechaRespuesta: todayISO, semanaOriginal: getWeekInfoByDate('2025-10-30').display },
            // S10 (Turno): Aprobado - Resuelto 5 días después. (KPI 2 & 3)
            { id: 10, tipo: 'Turno', empleado: 'Crew Gaston', turnoOriginalId: 112, turnoOriginal: '2025-11-02 12:00-20:00', turnoPedido: '2025-11-02 14:00-22:00', motivo: 'Evento deportivo', estado: 'Aprobado', fechaSolicitud: tenDaysAgoISO, motivoRechazo: null, fechaRespuesta: fiveDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-11-02').display },
            // S11 (PosEntr): Rechazado - Resuelto 4 días después. (KPI 3)
            { id: 11, tipo: 'PosicionEntrenador', empleado: 'Entrenador Sofi', turnoOriginalId: 117, turnoOriginal: '2025-10-31 21:00-05:00', posicionOriginal: 'Caja', posicionPedida: 'Sala', motivo: 'No me gusta nocturno', estado: 'Rechazado', fechaSolicitud: tenDaysAgoISO, motivoRechazo: 'Nocturno requiere Caja.', fechaRespuesta: fiveDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-31').display },
            // S12 (Turno): Aprobado - Resuelto 1 día después. (KPI 2 & 3)
            { id: 12, tipo: 'Turno', empleado: 'Crew Jose', turnoOriginalId: 113, turnoOriginal: '2025-11-03 08:00-14:00', turnoPedido: '2025-11-03 10:00-16:00', motivo: 'Cita médica', estado: 'Aprobado', fechaSolicitud: fiveDaysAgoISO, motivoRechazo: null, fechaRespuesta: yesterday.toISOString(), semanaOriginal: getWeekInfoByDate('2025-11-03').display },
            // S16 (Turno): Aprobado - Resuelto 5 días después. (KPI 2 & 3)
            { id: 16, tipo: 'Turno', empleado: 'Crew Andrea', turnoOriginalId: 108, turnoOriginal: '2025-10-29 08:00-16:00', turnoPedido: '2025-10-29 09:00-17:00', motivo: 'Cambio de bus', estado: 'Aprobado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: null, fechaRespuesta: tenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-29').display },


            // --- RESUELTAS FUERA DE PLAZO (3 total para KPI 3) ---
            // S13 (PosEntr): Rechazado - Resuelto 9 días después. (KPI 3)
            { id: 13, tipo: 'PosicionEntrenador', empleado: 'Entrenador Juan', turnoOriginalId: 115, turnoOriginal: '2025-10-30 10:00-18:00', posicionOriginal: 'AutoMac', posicionPedida: 'Cocina', motivo: 'Necesito más entrenamiento', estado: 'Rechazado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: 'Revisión tardía.', fechaRespuesta: fiveDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-30').display },
            // S14 (Turno): Aprobado - Resuelto 10 días después. (KPI 2 & 3)
            { id: 14, tipo: 'Turno', empleado: 'Crew Constanza', turnoOriginalId: 101, turnoOriginal: '2025-10-27 07:00-15:00', turnoPedido: '2025-10-27 09:00-17:00', motivo: 'Error en Planificación', estado: 'Aprobado', fechaSolicitud: fifteenDaysAgoISO, motivoRechazo: null, fechaRespuesta: fiveDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-27').display },
            // S17 (PosEntr): Rechazado - Resuelto 10 días después. (KPI 3)
            { id: 17, tipo: 'PosicionEntrenador', empleado: 'Entrenador Sofi', turnoOriginalId: 116, turnoOriginal: '2025-10-29 14:00-22:00', posicionOriginal: 'Cocina', posicionPedida: 'Caja', motivo: 'Quiero cambiar', estado: 'Rechazado', fechaSolicitud: twentyDaysAgoISO, motivoRechazo: 'Ya fue aprobado otro cambio', fechaRespuesta: tenDaysAgoISO, semanaOriginal: getWeekInfoByDate('2025-10-29').display },

            // S15: Solicitud de PosicionCrew (No relevante para KPI 3)
            { id: 15, tipo: 'PosicionCrew', empleado: 'Crew Constanza', turnoOriginalId: 101, turnoOriginal: '2025-10-28 08:00-13:00', posicionOriginal: 'Caja', posicionPedida: 'Automac', motivo: 'Más cómodo en Automac', estado: 'Aprobado', fechaSolicitud: yesterday.toISOString(), motivoRechazo: null, fechaRespuesta: yesterday.toISOString(), semanaOriginal: getWeekInfoByDate('2025-10-28').display },

        ];
        
        alert(`Demo cargado: ${allUsers.length} usuarios (10 operativos), ${planillaPublicada.length} turnos (80 operativos), y ${solicitudes.length} solicitudes (15 relevantes para KPIs).`);
        updateHomeDashboard(); // Actualiza contadores del Home
        populateWeekFilters(); // NEW: Populate filters immediately after loading data
    }
    
    // NEW: Utility function to check deadline status
    function checkDeadlineStatus(fechaSolicitudStr, fechaRespuestaStr) {
        if (!fechaRespuestaStr) return 'Pendiente';

        const solicitada = new Date(fechaSolicitudStr);
        const respondida = new Date(fechaRespuestaStr);
        const deadline = new Date(solicitada);
        deadline.setDate(solicitada.getDate() + 7); // 7 days deadline

        if (respondida <= deadline) {
            return 'dentro del plazo';
        } else {
            return 'fuera del plazo';
        }
    }
    
    // New function to populate the week filter dropdowns
    function populateWeekFilters() {
        if(!document.getElementById('filtroSemanaMalla')) return; // Exit if elements are not rendered yet

        const weeks = getAllWeeksInMalla();
        const optionsHtml = weeks.map(w => `<option value="${w.start}|${w.end}">${w.display}</option>`).join('');

        const defaultOption = '<option value="">(Mostrar rango completo)</option>';
        
        // Target the three select elements
        document.getElementById('filtroSemanaMalla').innerHTML = defaultOption + optionsHtml;
        document.getElementById('filtroSemanaCrew').innerHTML = defaultOption + optionsHtml;
        document.getElementById('filtroSemanaEntrenador').innerHTML = defaultOption + optionsHtml;
    }


    // Renderiza planilla completa (Gerente/Entrenador/RRHH)
    function renderMallaPublicada(){
        const tbody = document.querySelector('#tableMallaVisualizacion tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // NEW: Get selected week filter
        const selectedWeekValue = document.getElementById('filtroSemanaMalla').value;
        const [filterStart, filterEnd] = selectedWeekValue.split('|');
        
        let displayStart = mallaMetadata.startDate;
        let displayEnd = mallaMetadata.endDate;
        
        let filteredData = planillaPublicada;

        if (filterStart && filterEnd) {
            displayStart = filterStart;
            displayEnd = filterEnd;
            // Filter logic: date is between filterStart and filterEnd (inclusive)
            filteredData = planillaPublicada.filter(t => t.fecha >= filterStart && t.fecha <= filterEnd);
        }
        
        const headerHtml = `
            <strong>Semana/Rango:</strong> ${displayStart} - ${displayEnd}<br>
            <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            `;
        document.getElementById('mallaVisualizacionHeader').innerHTML = headerHtml;
        
        const filtro = document.getElementById('filtroMallaVisualizacion').value.toLowerCase();
        
        filteredData.filter(t => 
            t.empleado.toLowerCase().includes(filtro) || 
            (t.posicion && t.posicion.toLowerCase().includes(filtro)) ||
            t.fecha.includes(filtro)
        ).forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.empleado}</td><td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>${t.cargo}</td><td>${t.posicion || 'SIN POSICIÓN'}</td>`;
            tbody.appendChild(tr);
        });
    }

    /* ---------- FUNCIONES GERENTE (Planif. Posiciones) ---------- */
    
    // Renderiza la planilla para la planificación de posiciones (Gerente)
    function renderPlanifPosiciones(){
        const tbody = document.querySelector('#tablePlanifPosiciones tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroPlanifPosiciones').value.toLowerCase();
        
        planillaPublicada.filter(t => (t.cargo === 'Crew' || t.cargo === 'Entrenador') && (
            t.empleado.toLowerCase().includes(filtro) ||
            (t.posicion && t.posicion.toLowerCase().includes(filtro)) ||
            t.fecha.includes(filtro)
        )).forEach(t=>{
            const tr = document.createElement('tr');
            const posicionDisplay = t.posicion || 'PENDIENTE';
            tr.innerHTML = `<td>${t.empleado}</td><td>${t.fecha}</td><td>${t.inicio} - ${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${posicionDisplay}**</td><td class='actions'>
                <button class='btn btn-sec' onclick='asignarPosicion(${t.id}, "${t.empleado}", "${t.fecha}")'>Asignar/Editar Posición</button>
                <button class='btn' onclick='eliminarPosicion(${t.id})'>Eliminar</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    
    // Asigna/Edita posición (Gerente) - Actualiza el valor real
    function asignarPosicion(id, empleado, fecha){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        const currentPosicion = planillaPublicada[turnoIndex].posicion || '';
        
        const newPosicion = prompt(`Nueva posición para ${empleado} (${fecha}, Turno ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}):`, currentPosicion);

        if (newPosicion === null) {
            return;
        }

        if (newPosicion.trim() === '') {
             if (currentPosicion) {
                // Si el usuario borra la posición existente
                planillaPublicada[turnoIndex].posicion = null;
                alert('Posición eliminada/reseteada.');
                renderPlanifPosiciones();
            }
            return;
        }

        // Actualizar la posición
        planillaPublicada[turnoIndex].posicion = newPosicion.trim();
        alert(`Posición actualizada a **${newPosicion.trim()}** para ${empleado}.`);
        renderPlanifPosiciones();
    }

    // Elimina posición (Gerente) - Pone el valor en null
    function eliminarPosicion(id){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        if (confirm(`¿Eliminar la posición de ${planillaPublicada[turnoIndex].empleado} para el turno ${planillaPublicada[turnoIndex].fecha} ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}?`)) {
            planillaPublicada[turnoIndex].posicion = null;
            alert('Posición eliminada.');
            renderPlanifPosiciones();
        }
    }


    // Renderiza planilla personal (Crew)
    function renderMiPlanilla(){
      const tbody = document.querySelector('#tableMiPlanilla tbody');
      tbody.innerHTML = '';
      if(!currentUser) return;
      
      // NEW: Get selected week filter
      const selectedWeekValue = document.getElementById('filtroSemanaCrew').value;
      const [filterStart, filterEnd] = selectedWeekValue.split('|');
        
      let displayStart = mallaMetadata.startDate;
      let displayEnd = mallaMetadata.endDate;
      
      let filteredData = planillaPublicada.filter(t => t.empleado.toLowerCase() === currentUser.name.toLowerCase());

      if (filterStart && filterEnd) {
          displayStart = filterStart;
          displayEnd = filterEnd;
          // Filter logic: date is between filterStart and filterEnd (inclusive) AND is current user
          filteredData = filteredData.filter(t => t.fecha >= filterStart && t.fecha <= filterEnd);
      }
      
      const headerHtml = `
            <strong>Semana/Rango:</strong> ${displayStart} - ${displayEnd}<br>
            <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            `;
        document.getElementById('miPlanillaHeader').innerHTML = headerHtml;
      
      const filtro = document.getElementById('filtroMiPlanilla').value.toLowerCase();
        
      const mis = filteredData.filter(t => t.fecha.includes(filtro)); // Apply text filter to already filtered data

      mis.forEach(t=>{
        const tr = document.createElement('tr');
        // Se eliminó la columna "Acción"
        tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
        tbody.appendChild(tr);
      })
    }
    
    // Prepara la info del turno a cambiar (usado por la nueva sección de Crew)
    function prepararSolicitudCambioTurno(value) {
        if (!value) {
            document.getElementById('turnoIdACambiar').value = '';
            document.getElementById('turnoOriginalInfo').innerText = 'N/A';
            return;
        }
        
        const [turnoId, semanaDisplay] = value.split('|'); // MODIFICADO
        
        const turno = planillaPublicada.find(t => t.id == parseInt(turnoId));
        if (!turno) return;

        // Rellenar la información del turno a cambiar
        document.getElementById('turnoIdACambiar').value = `${turnoId}|${semanaDisplay}`; // MODIFICADO: Store ID and week for sending
        document.getElementById('turnoOriginalInfo').innerText = `${semanaDisplay} - ${turno.fecha} ${turno.inicio}-${turno.fin} (${turno.clasificacion.toUpperCase()}, Posición: ${turno.posicion || 'N/A'})`; // MODIFICADO: Display week
    }


    /* ---------- FUNCIONES SOLICITUDES (Crew/Entrenador -> Gerente) ---------- */
    
    // Llena el select de turnos disponibles para cambio de TURNO (Crew)
    function populateMisTurnosTurnoSelect(){
        const sel = document.getElementById('selectMisTurnosTurno');
        sel.innerHTML = '';
        if(!currentUser) return;
        
        // Filtra solo turnos con horas asignadas (no días libres)
        const mis = planillaPublicada.filter(t=>t.empleado.toLowerCase() === currentUser.name.toLowerCase() && t.inicio !== 'Libre');
        
        if(mis.length===0){
            const opt = document.createElement('option'); opt.text='(No tienes turnos asignados)'; opt.value=''; sel.appendChild(opt); return;
        }
        
        const defaultOpt = document.createElement('option');
        defaultOpt.text = 'Selecciona un turno a cambiar';
        defaultOpt.value = '';
        sel.appendChild(defaultOpt);
        
        mis.forEach((t,i)=>{
            const semana = getWeekInfoByDate(t.fecha); // NEW
            const opt = document.createElement('option');
            opt.value = `${t.id}|${semana.display}`; // MODIFICADO: Store shift ID and week display
            opt.text = `${semana.display} - ${t.fecha} - ${t.inicio} a ${t.fin} (${t.clasificacion.toUpperCase()})`; // MODIFICADO: Add week display
            sel.appendChild(opt);
        });
        document.getElementById('turnoOriginalInfo').innerText = 'N/A';
        // Force the display info update on change
        document.getElementById('selectMisTurnosTurno').onchange = () => prepararSolicitudCambioTurno(document.getElementById('selectMisTurnosTurno').value);
    }

    
    // Llena el select de TODOS los turnos para cambio de POSICIÓN (Entrenador)
    function populateTurnosAllSelect(){
      const sel = document.getElementById('selectTodosLosTurnos');
      sel.innerHTML = '';
      
      // Entrenador puede cambiar la posición de CUALQUIER turno operativo (Crew/Entrenador) que tenga horario.
      const todosOperativos = planillaPublicada.filter(t => (t.cargo === 'Crew' || t.cargo === 'Entrenador') && t.inicio !== 'Libre');
      
      if(todosOperativos.length===0){
        const opt = document.createElement('option'); opt.text='(No hay turnos operativos publicados)'; opt.value=''; sel.appendChild(opt); return;
      }
      
      todosOperativos.forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.id; opt.text = `${t.empleado} (${t.cargo}) - ${t.fecha} ${t.inicio}-${t.fin} (Posición: ${t.posicion || 'N/A'})`;
        sel.appendChild(opt);
      })
    }

    // Enviar solicitud de Turno (Crew)
    function enviarSolicitudTurno() {
        if(!currentUser) return alert('Debes iniciar sesión.');

        const fullValue = document.getElementById('turnoIdACambiar').value;
        if(!fullValue) return alert('Selecciona un turno válido para el cambio.');

        const [turnoId, semanaOriginal] = fullValue.split('|'); // MODIFICADO: Retrieve ID and week

        const turnoOriginal = planillaPublicada.find(t => t.id == turnoId);
        if(!turnoOriginal) return alert('Turno original no válido.');

        const sugFecha = document.getElementById('sugFecha').value;
        const sugInicio = document.getElementById('sugInicio').value;
        const sugFin = document.getElementById('sugFin').value;
        const motivo = document.getElementById('motivoCambio').value.trim();
        
        if(!sugFecha||!sugInicio||!sugFin||!motivo) return alert('Completa todos los campos de la solicitud de Turno.');
        
        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'Turno', 
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), 
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            turnoPedido: `${sugFecha} ${sugInicio}-${sugFin}`,
            motivo: motivo,
            motivoRechazo: null,
            fechaRespuesta: null,
            semanaOriginal: semanaOriginal // NEW FIELD
        };
        
        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioTurno').querySelector('form').reset();
        updateHomeDashboard();
        alert(`Solicitud de Turno enviada con éxito al Gerente (simulado)`);
        nav('miPlanilla'); // Redirección a su planilla
    }
    
    // Wrapper para enviar solicitud (solo maneja Turno ya que Posición Crew fue eliminada)
    function enviarSolicitud(tipo) {
        if (tipo === 'Turno') return enviarSolicitudTurno(); 
    }
    
    // Enviar solicitud de Posicion (Entrenador - Todos los turnos)
    function enviarSolicitudEntrenadorPosicionAll() {
        if(!currentUser) return alert('Debes iniciar sesión.');
        
        const sel = document.getElementById('selectTodosLosTurnos');
        if(!sel.value) return alert('Selecciona un turno válido para el cambio.');

        const turnoOriginal = planillaPublicada.find(t => t.id == parseInt(sel.value));
        
        const posicionPedida = document.getElementById('posicionPedidaAll').value.trim();
        const motivo = document.getElementById('motivoCambioPosAll').value.trim();
        
        if(!posicionPedida||!motivo) return alert('Completa todos los campos de la solicitud de Posición.');

        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'PosicionEntrenador', // Tipo para que lo revise el Gerente
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), // NEW: Save as ISO string
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            posicionOriginal: turnoOriginal.posicion,
            posicionPedida,
            motivo,
            empleadoAfectado: turnoOriginal.empleado, // Nuevo campo para saber quién es el dueño del turno
            motivoRechazo: null,
            fechaRespuesta: null
        };

        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioPosicionAll').querySelector('form').reset();
        
        updateHomeDashboard();
        alert(`Solicitud de Posición (Global) enviada con éxito al Gerente (simulado)`);
        nav('historialPosicion'); // Redirige a su historial de solicitudes
    }

    // Renderiza solicitudes para Gerente (Turno) o Gerente (PosicionEntrenador)
    function renderSolicitudes(tipo){
      let tbodyId;
      if (tipo === 'Turno') tbodyId = '#tableSolicitudesTurno tbody';
      else if (tipo === 'PosicionEntrenador') tbodyId = '#tableSolicitudesPosicion tbody';
      else return;
      
      const tbody = document.querySelector(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = '';
      
      const filteredSolicitudes = solicitudes.filter(s => s.tipo === tipo);

      filteredSolicitudes.forEach(s=>{
        const tr = document.createElement('tr');
        
        const fechaSolicitud = new Date(s.fechaSolicitud).toLocaleDateString('es-CL'); // NEW: Formatted date
        
        // NEW: Estado con plazo
        let estadoDisplay = s.estado;
        if (s.estado !== 'Pendiente') {
            const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
            estadoDisplay = `${s.estado} (${status})`;
        }
        
        let empleadoCol = s.empleado;
        let detalles;
        
        if (tipo === 'Turno') {
          // Add Fecha de Solicitud and Semana Original to table
          const semanaDisplay = s.semanaOriginal || 'N/A'; // NEW
          detalles = `<td>${empleadoCol}</td><td>${fechaSolicitud}</td><td>${semanaDisplay}</td><td>${s.turnoOriginal}</td><td>${s.turnoPedido}</td><td>${s.motivo}</td>`;
        } else { // PosicionEntrenador
          // Add Fecha de Solicitud to table
          if (s.empleado !== s.empleadoAfectado) {
             empleadoCol = `${s.empleado} (Para: ${s.empleadoAfectado})`;
          }
          // Note: Solicitudes de Posición no tienen "Semana Original" en la tabla, solo en el objeto solicitud
          detalles = `<td>${empleadoCol}</td><td>${fechaSolicitud}</td><td>${s.turnoOriginal}</td><td>${s.posicionOriginal || 'N/A'}</td><td>${s.posicionPedida}</td><td>${s.motivo}</td>`;
        }
        
        // Columna de Estado/Acciones
        const estadoHTML = `<span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>`;
        let accionesHTML = s.estado === 'Pendiente' ? 
            `<button class='btn btn-approve' onclick='aprobarSolicitud(${s.id}, "${tipo}")'>Aprobar</button>
            <button class='btn btn-reject' onclick='rechazarSolicitud(${s.id}, "${tipo}")'>Rechazar</button>` 
            : s.estado;

        // The structure of the row needs to be adjusted based on the new table headers
        // Since both tables start with Empleado and Fecha Solicitud, we can use the 'detalles'
        tr.innerHTML = `${detalles}<td>${estadoHTML}</td><td class='actions'>${accionesHTML}</td>`;
        tbody.appendChild(tr);
      })
    }

    // Lógica para APROBAR solicitud (Simulada, no actualiza planilla)
    function aprobarSolicitud(id, tipo){
      const s = solicitudes.find(x=>x.id===id); if(!s) return;
      
      if(!confirm(`¿Aprobar solicitud de ${tipo}? (Simulado - NOTA: La planilla no se actualiza en este mockup)`)) return;
      
      s.estado = 'Aprobado';
      s.fechaRespuesta = new Date().toISOString(); // NEW: Record response date
      s.motivoRechazo = null; // Limpiar motivo de rechazo si es aprobado
      renderSolicitudes(tipo);
      updateHomeDashboard(); // Actualizar el dashboard si estamos en home
    }
    
    // Lógica para RECHAZAR solicitud (Ahora pide un comentario)
    function rechazarSolicitud(id, tipo){
      const s = solicitudes.find(x=>x.id===id); if(!s) return;
      
      const promptTitle = `Rechazar solicitud de ${tipo}. Ingresa un comentario para el empleado:`;
      const motivoRechazo = prompt(promptTitle);
      
      if (motivoRechazo === null || motivoRechazo.trim() === '') {
          // Si presiona cancelar o deja vacío y acepta
          if (motivoRechazo !== null) alert('Debes ingresar un motivo de rechazo.');
          return;
      }
      
      s.estado = 'Rechazado';
      s.motivoRechazo = motivoRechazo.trim();
      s.fechaRespuesta = new Date().toISOString(); // NEW: Record response date
      
      renderSolicitudes(tipo);
      updateHomeDashboard(); // Actualizar el dashboard si estamos en home
    }

    // Renderiza el estado de las solicitudes para el Crew
    function renderEstadoSolicitudes(){
        const tbody = document.querySelector('#tableEstadoSolicitudes tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        // Filtra solo las solicitudes de Turno para Crew (ya que PosicionCrew fue eliminada)
        const mine = currentUser ? solicitudes.filter(s=>s.empleado.toLowerCase()===currentUser.name.toLowerCase() && s.tipo === 'Turno') : [];
        
        mine.forEach(s=>{
            let detalle = `<td>${s.turnoOriginal}</td><td>Turno: ${s.turnoPedido}</td>`;
            
            // NEW: Estado con plazo
            let estadoDisplay = s.estado;
            if (s.estado !== 'Pendiente') {
                const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
                estadoDisplay = `${s.estado} (${status})`;
            }

            let comentarioRechazo = '';
            if (s.estado === 'Rechazado' && s.motivoRechazo) {
                comentarioRechazo = `<div class="muted" style="margin-top:5px; color:var(--mc-red); font-weight: 600;">Motivo de Rechazo: ${s.motivoRechazo}</div>`;
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.tipo.replace('Posicion', 'Pos.')}</td>${detalle}<td><span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>${comentarioRechazo}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Renderiza el historial de turnos (Crew)
    function renderHistorial(){
        const tbody = document.querySelector('#tableHistorial tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroHistorial').value.toLowerCase();

        // En un sistema real, sería una vista filtrada por fecha. Aquí usamos la planilla actual.
        const misTurnosHist = planillaPublicada.filter(t=>t.empleado.toLowerCase()===currentUser.name.toLowerCase() && t.fecha.includes(filtro));

        misTurnosHist.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
            tbody.appendChild(tr);
        });
    }
    
    // Renderiza el historial de solicitudes de posición (Entrenador) - Renombrado a "Estado de Solicitudes (Mías)"
    function renderHistorialPosicion() {
        const tbody = document.querySelector('#tableHistorialPosicion tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // Filtra solo solicitudes de posición realizadas por el Entrenador (tipo 'PosicionEntrenador')
        const mine = currentUser ? solicitudes.filter(s => s.tipo === 'PosicionEntrenador' && s.empleado.toLowerCase() === currentUser.name.toLowerCase()) : [];

        mine.forEach(s => {
            let comentarioRechazo = '';
            if (s.estado === 'Rechazado' && s.motivoRechazo) {
                comentarioRechazo = `<div class="muted" style="margin-top:5px; color:var(--mc-red); font-weight: 600;">Motivo de Rechazo: ${s.motivoRechazo}</div>`;
            }

            // NEW: Estado con plazo
            let estadoDisplay = s.estado;
            if (s.estado !== 'Pendiente') {
                const status = checkDeadlineStatus(s.fechaSolicitud, s.fechaRespuesta);
                estadoDisplay = `${s.estado} (${status})`;
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${new Date(s.fechaSolicitud).toLocaleDateString('es-CL')}</td><td>${s.turnoOriginal}</td><td>${s.posicionPedida}</td><td><span class="estado-${s.estado.toLowerCase()}">${estadoDisplay}</span>${comentarioRechazo}</td>`;
            tbody.appendChild(tr);
        });
    }

    /* ---------- FUNCIONES ENTRENADOR (Mis Turnos y Solicitud) ---------- */

    function renderMiPlanillaEntrenador(){
        const tbody = document.querySelector('#tableMiPlanillaEntrenador tbody');
        tbody.innerHTML = '';
        if(!currentUser) return;
        
        // NEW: Get selected week filter
        const selectedWeekValue = document.getElementById('filtroSemanaEntrenador').value;
        const [filterStart, filterEnd] = selectedWeekValue.split('|');
        
        let displayStart = mallaMetadata.startDate;
        let displayEnd = mallaMetadata.endDate;
        
        let filteredData = planillaPublicada.filter(t => 
            t.empleado.toLowerCase() === currentUser.name.toLowerCase() && 
            t.cargo === 'Entrenador'
        );

        if (filterStart && filterEnd) {
            displayStart = filterStart;
            displayEnd = filterEnd;
            // Filter logic: date is between filterStart and filterEnd (inclusive) AND is current user
            filteredData = filteredData.filter(t => t.fecha >= filterStart && t.fecha <= filterEnd);
        }
        
        // Display metadata
        const headerHtml = `
              <strong>Semana/Rango:</strong> ${displayStart} - ${displayEnd}<br>
              <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            `;
        document.getElementById('miPlanillaEntrenadorHeader').innerHTML = headerHtml;
        
        const filtro = document.getElementById('filtroMiPlanillaEntrenador').value.toLowerCase();
        
        // Filter for current user AND role 'Entrenador'
        const mis = filteredData.filter(t => t.fecha.includes(filtro)); // Apply text filter to already filtered data

        mis.forEach(t=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
            tbody.appendChild(tr);
        });
    }

    function populateMisTurnosTurnoSelectEntrenador(){
        const sel = document.getElementById('selectMisTurnosTurnoEntrenador');
        sel.innerHTML = '';
        if(!currentUser) return;
        
        // Filter for current user AND role 'Entrenador' AND not 'Libre'
        const mis = planillaPublicada.filter(t=>
            t.empleado.toLowerCase() === currentUser.name.toLowerCase() && 
            t.cargo === 'Entrenador' && 
            t.inicio !== 'Libre'
        );
        
        if(mis.length===0){
            const opt = document.createElement('option'); opt.text='(No tienes turnos de Entrenador asignados)'; opt.value=''; sel.appendChild(opt); return;
        }
        
        const defaultOpt = document.createElement('option');
        defaultOpt.text = 'Selecciona un turno a cambiar';
        defaultOpt.value = '';
        sel.appendChild(defaultOpt);
        
        mis.forEach((t,i)=>{
            const semana = getWeekInfoByDate(t.fecha); // NEW
            const opt = document.createElement('option');
            opt.value = `${t.id}|${semana.display}`; // MODIFICADO: Store shift ID and week display
            opt.text = `${semana.display} - ${t.fecha} - ${t.inicio} a ${t.fin} (${t.clasificacion.toUpperCase()})`; // MODIFICADO: Add week display
            sel.appendChild(opt);
        });
        document.getElementById('turnoOriginalInfoEntrenador').innerText = 'N/A';
        // Force the display info update on change
        document.getElementById('selectMisTurnosTurnoEntrenador').onchange = () => prepararSolicitudCambioTurnoEntrenador(document.getElementById('selectMisTurnosTurnoEntrenador').value);
    }

    function prepararSolicitudCambioTurnoEntrenador(value) {
        if (!value) {
            document.getElementById('turnoIdACambiarEntrenador').value = '';
            document.getElementById('turnoOriginalInfoEntrenador').innerText = 'N/A';
            return;
        }
        
        const [turnoId, semanaDisplay] = value.split('|'); // MODIFICADO
        
        const turno = planillaPublicada.find(t => t.id == parseInt(turnoId));
        if (!turno) return;

        document.getElementById('turnoIdACambiarEntrenador').value = `${turnoId}|${semanaDisplay}`; // MODIFICADO: Store ID and week
        document.getElementById('turnoOriginalInfoEntrenador').innerText = `${semanaDisplay} - ${turno.fecha} ${turno.inicio}-${turno.fin} (${turno.clasificacion.toUpperCase()}, Posición: ${turno.posicion || 'N/A'})`; // MODIFICADO: Display week
    }

    function enviarSolicitudTurnoEntrenador() {
        if(!currentUser) return alert('Debes iniciar sesión.');
        if(currentUser.role !== 'entrenador') return alert('Solo los Entrenadores pueden usar esta función.');

        const fullValue = document.getElementById('turnoIdACambiarEntrenador').value;
        if(!fullValue) return alert('Selecciona un turno válido para el cambio.');
        
        const [turnoId, semanaOriginal] = fullValue.split('|'); // MODIFICADO: Retrieve ID and week

        const turnoOriginal = planillaPublicada.find(t => t.id == turnoId);
        if(!turnoOriginal || turnoOriginal.cargo !== 'Entrenador') return alert('Turno original no válido o no es un turno de Entrenador.');

        const sugFecha = document.getElementById('sugFechaEntrenador').value;
        const sugInicio = document.getElementById('sugInicioEntrenador').value;
        const sugFin = document.getElementById('sugFinEntrenador').value;
        const motivo = document.getElementById('motivoCambioEntrenador').value.trim();
        
        if(!sugFecha||!sugInicio||!sugFin||!motivo) return alert('Completa todos los campos de la solicitud de Turno.');
        
        let solicitud = { 
            id: Date.now(), 
            empleado: currentUser.name, 
            tipo: 'Turno', 
            estado: 'Pendiente', 
            fechaSolicitud: new Date().toISOString(), 
            turnoOriginalId: turnoOriginal.id,
            turnoOriginal: `${turnoOriginal.fecha} ${turnoOriginal.inicio}-${turnoOriginal.fin}`,
            turnoPedido: `${sugFecha} ${sugInicio}-${sugFin}`,
            motivo: motivo,
            motivoRechazo: null,
            fechaRespuesta: null,
            semanaOriginal: semanaOriginal // NEW FIELD
        };
        
        solicitudes.push(solicitud);
        document.getElementById('solicitarCambioTurnoEntrenadorWrapper').querySelector('form').reset();
        updateHomeDashboard();
        alert(`Solicitud de Turno enviada con éxito al Gerente (simulado)`);
        nav('misTurnosYCambioEntrenador'); 
    }
    
    /* ---------- FUNCIONES GERENTE (Planif. Posiciones) ---------- */
    
    // Renderiza la planilla para la planificación de posiciones (Gerente)
    function renderPlanifPosiciones(){
        const tbody = document.querySelector('#tablePlanifPosiciones tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroPlanifPosiciones').value.toLowerCase();
        
        planillaPublicada.filter(t => (t.cargo === 'Crew' || t.cargo === 'Entrenador') && (
            t.empleado.toLowerCase().includes(filtro) ||
            (t.posicion && t.posicion.toLowerCase().includes(filtro)) ||
            t.fecha.includes(filtro)
        )).forEach(t=>{
            const tr = document.createElement('tr');
            const posicionDisplay = t.posicion || 'PENDIENTE';
            tr.innerHTML = `<td>${t.empleado}</td><td>${t.fecha}</td><td>${t.inicio} - ${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${posicionDisplay}**</td><td class='actions'>
                <button class='btn btn-sec' onclick='asignarPosicion(${t.id}, "${t.empleado}", "${t.fecha}")'>Asignar/Editar Posición</button>
                <button class='btn' onclick='eliminarPosicion(${t.id})'>Eliminar</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    
    // Asigna/Edita posición (Gerente) - Actualiza el valor real
    function asignarPosicion(id, empleado, fecha){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        const currentPosicion = planillaPublicada[turnoIndex].posicion || '';
        
        const newPosicion = prompt(`Nueva posición para ${empleado} (${fecha}, Turno ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}):`, currentPosicion);

        if (newPosicion === null) {
            return;
        }

        if (newPosicion.trim() === '') {
             if (currentPosicion) {
                // Si el usuario borra la posición existente
                planillaPublicada[turnoIndex].posicion = null;
                alert('Posición eliminada/reseteada.');
                renderPlanifPosiciones();
            }
            return;
        }

        // Actualizar la posición
        planillaPublicada[turnoIndex].posicion = newPosicion.trim();
        alert(`Posición actualizada a **${newPosicion.trim()}** para ${empleado}.`);
        renderPlanifPosiciones();
    }

    // Elimina posición (Gerente) - Pone el valor en null
    function eliminarPosicion(id){
        const turnoIndex = planillaPublicada.findIndex(t => t.id === id);
        if (turnoIndex === -1) return alert('Turno no encontrado.');
        
        if (confirm(`¿Eliminar la posición de ${planillaPublicada[turnoIndex].empleado} para el turno ${planillaPublicada[turnoIndex].fecha} ${planillaPublicada[turnoIndex].inicio}-${planillaPublicada[turnoIndex].fin}?`)) {
            planillaPublicada[turnoIndex].posicion = null;
            alert('Posición eliminada.');
            renderPlanifPosiciones();
        }
    }


    // Renderiza planilla personal (Crew)
    function renderMiPlanilla(){
      const tbody = document.querySelector('#tableMiPlanilla tbody');
      tbody.innerHTML = '';
      if(!currentUser) return;
      
      // NEW: Get selected week filter
      const selectedWeekValue = document.getElementById('filtroSemanaCrew').value;
      const [filterStart, filterEnd] = selectedWeekValue.split('|');
        
      let displayStart = mallaMetadata.startDate;
      let displayEnd = mallaMetadata.endDate;
      
      let filteredData = planillaPublicada.filter(t => t.empleado.toLowerCase() === currentUser.name.toLowerCase());

      if (filterStart && filterEnd) {
          displayStart = filterStart;
          displayEnd = filterEnd;
          // Filter logic: date is between filterStart and filterEnd (inclusive) AND is current user
          filteredData = filteredData.filter(t => t.fecha >= filterStart && t.fecha <= filterEnd);
      }
      
      const headerHtml = `
            <strong>Semana/Rango:</strong> ${displayStart} - ${displayEnd}<br>
            <span class="muted">Publicada: ${mallaMetadata.publicationDate}</span>
            `;
        document.getElementById('miPlanillaHeader').innerHTML = headerHtml;
      
      const filtro = document.getElementById('filtroMiPlanilla').value.toLowerCase();
        
      const mis = filteredData.filter(t => t.fecha.includes(filtro));

      mis.forEach(t=>{
        const tr = document.createElement('tr');
        // Se eliminó la columna "Acción"
        tr.innerHTML = `<td>${t.fecha}</td><td>${t.inicio}</td><td>${t.fin}</td><td>${t.clasificacion.toUpperCase()}</td><td>**${t.posicion || 'N/A'}**</td>`;
        tbody.appendChild(tr);
      })
    }
    
    /* ---------- FUNCIONES ADMIN (Gestión de Usuarios) ---------- */

    function guardarUsuarioAdmin() {
        const name = document.getElementById('adminNewName').value.trim();
        const user = document.getElementById('adminNewUser').value.trim();
        const pass = document.getElementById('adminNewPass').value.trim();
        const role = document.getElementById('adminNewRole').value;

        if (!name || !user || !pass || !role) {
            return alert('Todos los campos son obligatorios para crear un usuario.');
        }

        if (allUsers.some(u => u.user === user)) {
            return alert('El usuario (login) ya existe. Intente con otro.');
        }

        const newUser = {
            name: name,
            role: role,
            user: user,
            pass: pass
        };

        allUsers.push(newUser);
        alert(`Usuario "${name}" (${ROLES[role]}) creado con éxito.`);
        
        // Reset form and re-render table
        document.getElementById('adminUserForm').reset();
        toggleForm('formCrearUsuario');
        renderTablaUsuarios();
    }
    
    /* ---------- FUNCIONES GERENTE (Creación de Malla) ---------- */

    // Replicando funciones para Gerente (necesarias para evitar la eliminación al final)
    
    function guardarTurnoRRHH() {
        const id = document.getElementById('rrhhTurnoId').value;
        const [empleado, cargo] = document.getElementById('rrhhEmpleadoTurno').value.split('|');
        const fecha = document.getElementById('rrhhDiaTurno').value;
        const tipoTurno = document.getElementById('rrhhTipoTurno').value;
        const clasificacionTurno = document.getElementById('rrhhClasificacionTurno').value;

        let inicio = document.getElementById('rrhhHoraInicio').value;
        let fin = document.getElementById('rrhhHoraFin').value;
        
        const existingIndex = planillaPublicada.findIndex(t => t.id == id);
        
        if (tipoTurno === 'Libre') {
            if (existingIndex !== -1) {
                planillaPublicada.splice(existingIndex, 1);
            }
            alert('Día marcado como Libre/No Asignado (Simulado)');
            toggleForm('formAgregarTurnoRRHH');
            renderMallaRRHH();
            updateHomeDashboard();
            return;
        }

        if (!inicio || !fin) return alert('Debes ingresar la hora de inicio y fin para un turno normal.');

        if (id) {
            if (existingIndex !== -1) {
                planillaPublicada[existingIndex].fecha = fecha;
                planillaPublicada[existingIndex].inicio = inicio;
                planillaPublicada[existingIndex].fin = fin;
                planillaPublicada[existingIndex].empleado = empleado;
                planillaPublicada[existingIndex].cargo = ROLES[cargo];
                planillaPublicada[existingIndex].clasificacion = clasificacionTurno;
                alert('Turno actualizado con éxito (simulado)');
            }
        } else {
            const nuevoTurno = {
                id: Date.now(),
                empleado,
                fecha,
                inicio,
                fin,
                cargo: ROLES[cargo],
                posicion: null,
                clasificacion: clasificacionTurno
            };
            planillaPublicada.push(nuevoTurno);
            alert('Nuevo turno agregado con éxito (simulado)');
        }
        
        toggleForm('formAgregarTurnoRRHH');
        renderMallaRRHH();
        updateHomeDashboard();
    }


    // Al iniciar, mostrar login
    nav('login');
  </script>
</body>
</html>
